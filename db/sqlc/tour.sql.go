// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: tour.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const addTourDestination = `-- name: AddTourDestination :exec
INSERT INTO tour_diem_den (
    tour_id,
    diem_den_id,
    thu_tu_tham_quan
) VALUES (
    $1, $2, $3
)
`

type AddTourDestinationParams struct {
	TourID        int32  `json:"tour_id"`
	DiemDenID     int32  `json:"diem_den_id"`
	ThuTuThamQuan *int32 `json:"thu_tu_tham_quan"`
}

func (q *Queries) AddTourDestination(ctx context.Context, arg AddTourDestinationParams) error {
	_, err := q.db.Exec(ctx, addTourDestination, arg.TourID, arg.DiemDenID, arg.ThuTuThamQuan)
	return err
}

const addTourImage = `-- name: AddTourImage :one
INSERT INTO anh_tour (
    tour_id,
    duong_dan,
    mo_ta,
    la_anh_chinh,
    thu_tu_hien_thi
) VALUES (
    $1, $2, $3, $4, $5
)
RETURNING id, tour_id, duong_dan, mo_ta, la_anh_chinh, thu_tu_hien_thi, ngay_tao
`

type AddTourImageParams struct {
	TourID       int32   `json:"tour_id"`
	DuongDan     string  `json:"duong_dan"`
	MoTa         *string `json:"mo_ta"`
	LaAnhChinh   *bool   `json:"la_anh_chinh"`
	ThuTuHienThi *int32  `json:"thu_tu_hien_thi"`
}

func (q *Queries) AddTourImage(ctx context.Context, arg AddTourImageParams) (AnhTour, error) {
	row := q.db.QueryRow(ctx, addTourImage,
		arg.TourID,
		arg.DuongDan,
		arg.MoTa,
		arg.LaAnhChinh,
		arg.ThuTuHienThi,
	)
	var i AnhTour
	err := row.Scan(
		&i.ID,
		&i.TourID,
		&i.DuongDan,
		&i.MoTa,
		&i.LaAnhChinh,
		&i.ThuTuHienThi,
		&i.NgayTao,
	)
	return i, err
}

const countAllTours = `-- name: CountAllTours :one
SELECT COUNT(*) 
FROM tour t
WHERE t.dang_hoat_dong = TRUE
`

func (q *Queries) CountAllTours(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countAllTours)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countSearchTours = `-- name: CountSearchTours :one
SELECT COUNT(*)
FROM tour t
WHERE t.dang_hoat_dong = TRUE
  -- Tìm kiếm từ khoá trong tiêu đề và hoạt động
  AND (
    $1::text IS NULL 
    OR to_tsvector('vietnamese', t.tieu_de) @@ plainto_tsquery('vietnamese', $1)
    OR EXISTS (
      SELECT 1 FROM lich_trinh lt
      JOIN hoat_dong_trong_ngay hd ON hd.lich_trinh_id = lt.id
      WHERE lt.tour_id = t.id 
        AND to_tsvector('vietnamese', hd.ten) @@ plainto_tsquery('vietnamese', $1)
    )
  )
  -- Lọc theo điểm đến (tên hoặc ID)
  AND (
    $2::int IS NULL 
    OR EXISTS (
      SELECT 1 FROM tour_diem_den tdd
      WHERE tdd.tour_id = t.id AND tdd.diem_den_id = $2
    )
  )
  AND (
    $3::text IS NULL 
    OR EXISTS (
      SELECT 1 FROM tour_diem_den tdd
      JOIN diem_den d ON d.id = tdd.diem_den_id
      WHERE tdd.tour_id = t.id 
        AND (
          unaccent(lower(d.ten)) LIKE '%' || unaccent(lower($3)) || '%'
          OR unaccent(lower(d.tinh)) LIKE '%' || unaccent(lower($3)) || '%'
          OR unaccent(lower(d.quoc_gia)) LIKE '%' || unaccent(lower($3)) || '%'
        )
    )
  )
  -- Lọc theo số ngày
  AND ($4::int IS NULL OR t.so_ngay >= $4)
  AND ($5::int IS NULL OR t.so_ngay <= $5)
  -- Lọc theo số đêm  
  AND ($6::int IS NULL OR t.so_dem >= $6)
  AND ($7::int IS NULL OR t.so_dem <= $7)
`

type CountSearchToursParams struct {
	Keyword    *string `json:"keyword"`
	DiemDenID  *int32  `json:"diem_den_id"`
	DiemDenTen *string `json:"diem_den_ten"`
	SoNgayMin  *int32  `json:"so_ngay_min"`
	SoNgayMax  *int32  `json:"so_ngay_max"`
	SoDemMin   *int32  `json:"so_dem_min"`
	SoDemMax   *int32  `json:"so_dem_max"`
}

func (q *Queries) CountSearchTours(ctx context.Context, arg CountSearchToursParams) (int64, error) {
	row := q.db.QueryRow(ctx, countSearchTours,
		arg.Keyword,
		arg.DiemDenID,
		arg.DiemDenTen,
		arg.SoNgayMin,
		arg.SoNgayMax,
		arg.SoDemMin,
		arg.SoDemMax,
	)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countToursBySupplier = `-- name: CountToursBySupplier :one
SELECT COUNT(*) FROM tour
WHERE nha_cung_cap_id = $1
`

func (q *Queries) CountToursBySupplier(ctx context.Context, nhaCungCapID pgtype.UUID) (int64, error) {
	row := q.db.QueryRow(ctx, countToursBySupplier, nhaCungCapID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createDiscountTour = `-- name: CreateDiscountTour :one
INSERT INTO giam_gia_tour (
    tour_id,
    phan_tram,
    ngay_bat_dau,
    ngay_ket_thuc,
    ngay_tao,
    ngay_cap_nhat
) VALUES (
    $1, $2, $3, $4, $5, $6
)
RETURNING id, tour_id, phan_tram, ngay_bat_dau, ngay_ket_thuc, ngay_tao, ngay_cap_nhat
`

type CreateDiscountTourParams struct {
	TourID      int32            `json:"tour_id"`
	PhanTram    pgtype.Numeric   `json:"phan_tram"`
	NgayBatDau  pgtype.Date      `json:"ngay_bat_dau"`
	NgayKetThuc pgtype.Date      `json:"ngay_ket_thuc"`
	NgayTao     pgtype.Timestamp `json:"ngay_tao"`
	NgayCapNhat pgtype.Timestamp `json:"ngay_cap_nhat"`
}

func (q *Queries) CreateDiscountTour(ctx context.Context, arg CreateDiscountTourParams) (GiamGiaTour, error) {
	row := q.db.QueryRow(ctx, createDiscountTour,
		arg.TourID,
		arg.PhanTram,
		arg.NgayBatDau,
		arg.NgayKetThuc,
		arg.NgayTao,
		arg.NgayCapNhat,
	)
	var i GiamGiaTour
	err := row.Scan(
		&i.ID,
		&i.TourID,
		&i.PhanTram,
		&i.NgayBatDau,
		&i.NgayKetThuc,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const createTour = `-- name: CreateTour :one

INSERT INTO tour (
    tieu_de,
    mo_ta,
    danh_muc_id,
    so_ngay,
    so_dem,
    gia_nguoi_lon,
    gia_tre_em,
    don_vi_tien_te,
    trang_thai,
    noi_bat,
    nha_cung_cap_id,
    dang_hoat_dong
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12
)
RETURNING id, tieu_de, mo_ta, danh_muc_id, so_ngay, so_dem, gia_nguoi_lon, gia_tre_em, don_vi_tien_te, trang_thai, noi_bat, nha_cung_cap_id, dang_hoat_dong, ngay_tao, ngay_cap_nhat
`

type CreateTourParams struct {
	TieuDe       string         `json:"tieu_de"`
	MoTa         *string        `json:"mo_ta"`
	DanhMucID    *int32         `json:"danh_muc_id"`
	SoNgay       int32          `json:"so_ngay"`
	SoDem        int32          `json:"so_dem"`
	GiaNguoiLon  pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm     pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe  *string        `json:"don_vi_tien_te"`
	TrangThai    *string        `json:"trang_thai"`
	NoiBat       *bool          `json:"noi_bat"`
	NhaCungCapID pgtype.UUID    `json:"nha_cung_cap_id"`
	DangHoatDong *bool          `json:"dang_hoat_dong"`
}

// ==================== TOUR CRUD OPERATIONS ====================
func (q *Queries) CreateTour(ctx context.Context, arg CreateTourParams) (Tour, error) {
	row := q.db.QueryRow(ctx, createTour,
		arg.TieuDe,
		arg.MoTa,
		arg.DanhMucID,
		arg.SoNgay,
		arg.SoDem,
		arg.GiaNguoiLon,
		arg.GiaTreEm,
		arg.DonViTienTe,
		arg.TrangThai,
		arg.NoiBat,
		arg.NhaCungCapID,
		arg.DangHoatDong,
	)
	var i Tour
	err := row.Scan(
		&i.ID,
		&i.TieuDe,
		&i.MoTa,
		&i.DanhMucID,
		&i.SoNgay,
		&i.SoDem,
		&i.GiaNguoiLon,
		&i.GiaTreEm,
		&i.DonViTienTe,
		&i.TrangThai,
		&i.NoiBat,
		&i.NhaCungCapID,
		&i.DangHoatDong,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const deleteDiscountTour = `-- name: DeleteDiscountTour :exec
DELETE FROM giam_gia_tour
WHERE id = $1 AND tour_id = $2
`

type DeleteDiscountTourParams struct {
	ID     int32 `json:"id"`
	TourID int32 `json:"tour_id"`
}

func (q *Queries) DeleteDiscountTour(ctx context.Context, arg DeleteDiscountTourParams) error {
	_, err := q.db.Exec(ctx, deleteDiscountTour, arg.ID, arg.TourID)
	return err
}

const deleteTour = `-- name: DeleteTour :exec
DELETE FROM tour
WHERE id = $1
`

func (q *Queries) DeleteTour(ctx context.Context, id int32) error {
	_, err := q.db.Exec(ctx, deleteTour, id)
	return err
}

const deleteTourImage = `-- name: DeleteTourImage :exec
DELETE FROM anh_tour
WHERE id = $1 AND tour_id = $2
`

type DeleteTourImageParams struct {
	ID     int32 `json:"id"`
	TourID int32 `json:"tour_id"`
}

func (q *Queries) DeleteTourImage(ctx context.Context, arg DeleteTourImageParams) error {
	_, err := q.db.Exec(ctx, deleteTourImage, arg.ID, arg.TourID)
	return err
}

const filterTours = `-- name: FilterTours :many
SELECT
  t.id,
  t.tieu_de,
  t.mo_ta,
  t.so_ngay,
  t.so_dem,
  t.gia_nguoi_lon,
  t.gia_tre_em,
  t.don_vi_tien_te,
  t.noi_bat,
  dm.ten AS danh_muc_ten,
  (
    SELECT a.duong_dan
    FROM anh_tour a
    WHERE a.tour_id = t.id AND a.la_anh_chinh = true
    LIMIT 1
  ) AS anh_chinh,
  COALESCE(AVG(dg.diem_danh_gia), 0) as avg_rating
FROM tour t
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN danh_gia dg ON t.id = dg.tour_id AND dg.dang_hoat_dong = true
WHERE t.dang_hoat_dong = true
  AND ($3::int IS NULL OR t.danh_muc_id = $3)
  AND ($4::numeric IS NULL OR t.gia_nguoi_lon >= $4)
  AND ($5::numeric IS NULL OR t.gia_nguoi_lon <= $5)
  AND ($6::int IS NULL OR t.so_ngay >= $6)
  AND ($7::int IS NULL OR t.so_ngay <= $7)
GROUP BY t.id, dm.ten
HAVING ($8::float IS NULL OR COALESCE(AVG(dg.diem_danh_gia), 0) >= $8)
ORDER BY 
  CASE WHEN $9::text = 'price_asc' THEN t.gia_nguoi_lon END ASC,
  CASE WHEN $9::text = 'price_desc' THEN t.gia_nguoi_lon END DESC,
  CASE WHEN $9::text = 'rating' THEN AVG(dg.diem_danh_gia) END DESC NULLS LAST,
  CASE WHEN $9::text = 'newest' THEN t.ngay_tao END DESC,
  t.noi_bat DESC,
  t.ngay_tao DESC
LIMIT $1 OFFSET $2
`

type FilterToursParams struct {
	Limit     int32          `json:"limit"`
	Offset    int32          `json:"offset"`
	DanhMucID *int32         `json:"danh_muc_id"`
	GiaMin    pgtype.Numeric `json:"gia_min"`
	GiaMax    pgtype.Numeric `json:"gia_max"`
	SoNgayMin *int32         `json:"so_ngay_min"`
	SoNgayMax *int32         `json:"so_ngay_max"`
	RatingMin *float64       `json:"rating_min"`
	SortBy    *string        `json:"sort_by"`
}

type FilterToursRow struct {
	ID          int32          `json:"id"`
	TieuDe      string         `json:"tieu_de"`
	MoTa        *string        `json:"mo_ta"`
	SoNgay      int32          `json:"so_ngay"`
	SoDem       int32          `json:"so_dem"`
	GiaNguoiLon pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm    pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe *string        `json:"don_vi_tien_te"`
	NoiBat      *bool          `json:"noi_bat"`
	DanhMucTen  *string        `json:"danh_muc_ten"`
	AnhChinh    string         `json:"anh_chinh"`
	AvgRating   interface{}    `json:"avg_rating"`
}

func (q *Queries) FilterTours(ctx context.Context, arg FilterToursParams) ([]FilterToursRow, error) {
	rows, err := q.db.Query(ctx, filterTours,
		arg.Limit,
		arg.Offset,
		arg.DanhMucID,
		arg.GiaMin,
		arg.GiaMax,
		arg.SoNgayMin,
		arg.SoNgayMax,
		arg.RatingMin,
		arg.SortBy,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []FilterToursRow
	for rows.Next() {
		var i FilterToursRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.AnhChinh,
			&i.AvgRating,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getAllTour = `-- name: GetAllTour :many
SELECT
  t.id,
  t.tieu_de,
  t.mo_ta,
  t.danh_muc_id,
  t.so_ngay,
  t.so_dem,
  t.gia_nguoi_lon,
  t.gia_tre_em,
  t.don_vi_tien_te,
  t.trang_thai,
  t.noi_bat,
  dm.ten AS danh_muc_ten,
  ncc.ten AS nha_cung_cap_ten,
  (
    SELECT a.duong_dan
    FROM anh_tour a
    WHERE a.tour_id = t.id
    ORDER BY COALESCE(a.la_anh_chinh, false) DESC, COALESCE(a.thu_tu_hien_thi, 0) ASC, a.id ASC
    LIMIT 1
  ) AS anh_chinh,
  dd.diem_den,
  COALESCE(dg.avg_rating, 0) as avg_rating,
  COALESCE(dg.total_reviews, 0) as total_reviews,
  kh.next_departure_date,
  ggt.phan_tram as giam_gia_phan_tram,
  -- Tính giá sau giảm
  CASE 
    WHEN ggt.phan_tram IS NOT NULL THEN 
      ROUND(t.gia_nguoi_lon * (1 - ggt.phan_tram / 100), 2)
    ELSE t.gia_nguoi_lon
  END as gia_sau_giam_nguoi_lon,
  CASE 
    WHEN ggt.phan_tram IS NOT NULL THEN 
      ROUND(t.gia_tre_em * (1 - ggt.phan_tram / 100), 2)
    ELSE t.gia_tre_em
  END as gia_sau_giam_tre_em
FROM tour t
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN nha_cung_cap ncc ON ncc.id = t.nha_cung_cap_id
LEFT JOIN (
  SELECT td.tour_id, array_agg(DISTINCT d.ten ORDER BY d.ten) AS diem_den
  FROM tour_diem_den td
  JOIN diem_den d ON d.id = td.diem_den_id
  GROUP BY td.tour_id
) dd ON dd.tour_id = t.id
LEFT JOIN (
  SELECT tour_id, AVG(diem_danh_gia)::float AS avg_rating, COUNT(*)::int AS total_reviews
  FROM danh_gia
  WHERE dang_hoat_dong = TRUE
  GROUP BY tour_id
) dg ON dg.tour_id = t.id
LEFT JOIN (
  SELECT
    tour_id,
    MIN(ngay_khoi_hanh) FILTER (WHERE ngay_khoi_hanh >= CURRENT_DATE AND trang_thai IN ('len_lich','xac_nhan','con_cho')) AS next_departure_date
  FROM khoi_hanh_tour
  GROUP BY tour_id
) kh ON kh.tour_id = t.id
LEFT JOIN (
  SELECT tour_id, MAX(phan_tram) as phan_tram
  FROM giam_gia_tour
  WHERE CURRENT_DATE BETWEEN ngay_bat_dau AND ngay_ket_thuc
  GROUP BY tour_id
) ggt ON ggt.tour_id = t.id
WHERE t.dang_hoat_dong = TRUE
ORDER BY t.noi_bat DESC, t.ngay_tao DESC
LIMIT $1 OFFSET $2
`

type GetAllTourParams struct {
	Limit  int32 `json:"limit"`
	Offset int32 `json:"offset"`
}

type GetAllTourRow struct {
	ID                 int32          `json:"id"`
	TieuDe             string         `json:"tieu_de"`
	MoTa               *string        `json:"mo_ta"`
	DanhMucID          *int32         `json:"danh_muc_id"`
	SoNgay             int32          `json:"so_ngay"`
	SoDem              int32          `json:"so_dem"`
	GiaNguoiLon        pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm           pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe        *string        `json:"don_vi_tien_te"`
	TrangThai          *string        `json:"trang_thai"`
	NoiBat             *bool          `json:"noi_bat"`
	DanhMucTen         *string        `json:"danh_muc_ten"`
	NhaCungCapTen      *string        `json:"nha_cung_cap_ten"`
	AnhChinh           string         `json:"anh_chinh"`
	DiemDen            interface{}    `json:"diem_den"`
	AvgRating          float64        `json:"avg_rating"`
	TotalReviews       int32          `json:"total_reviews"`
	NextDepartureDate  interface{}    `json:"next_departure_date"`
	GiamGiaPhanTram    interface{}    `json:"giam_gia_phan_tram"`
	GiaSauGiamNguoiLon interface{}    `json:"gia_sau_giam_nguoi_lon"`
	GiaSauGiamTreEm    interface{}    `json:"gia_sau_giam_tre_em"`
}

func (q *Queries) GetAllTour(ctx context.Context, arg GetAllTourParams) ([]GetAllTourRow, error) {
	rows, err := q.db.Query(ctx, getAllTour, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetAllTourRow
	for rows.Next() {
		var i GetAllTourRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.NhaCungCapTen,
			&i.AnhChinh,
			&i.DiemDen,
			&i.AvgRating,
			&i.TotalReviews,
			&i.NextDepartureDate,
			&i.GiamGiaPhanTram,
			&i.GiaSauGiamNguoiLon,
			&i.GiaSauGiamTreEm,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getAllTourCategory = `-- name: GetAllTourCategory :many
select danh_muc_tour.id, danh_muc_tour.ten, danh_muc_tour.mo_ta, danh_muc_tour.anh, danh_muc_tour.dang_hoat_dong, danh_muc_tour.ngay_tao, total_tours 
from danh_muc_tour
left join (
    select danh_muc_id, COALESCE(COUNT(*), 0) AS total_tours
    from tour
    where dang_hoat_dong = true
    group by danh_muc_id
) as t on t.danh_muc_id = danh_muc_tour.id
`

type GetAllTourCategoryRow struct {
	ID           int32            `json:"id"`
	Ten          string           `json:"ten"`
	MoTa         *string          `json:"mo_ta"`
	Anh          *string          `json:"anh"`
	DangHoatDong *bool            `json:"dang_hoat_dong"`
	NgayTao      pgtype.Timestamp `json:"ngay_tao"`
	TotalTours   interface{}      `json:"total_tours"`
}

func (q *Queries) GetAllTourCategory(ctx context.Context) ([]GetAllTourCategoryRow, error) {
	rows, err := q.db.Query(ctx, getAllTourCategory)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetAllTourCategoryRow
	for rows.Next() {
		var i GetAllTourCategoryRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.MoTa,
			&i.Anh,
			&i.DangHoatDong,
			&i.NgayTao,
			&i.TotalTours,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDiscountsByTourID = `-- name: GetDiscountsByTourID :many
SELECT id, tour_id, phan_tram, ngay_bat_dau, ngay_ket_thuc, ngay_tao, ngay_cap_nhat FROM giam_gia_tour
WHERE tour_id = $1
ORDER BY ngay_bat_dau DESC
`

func (q *Queries) GetDiscountsByTourID(ctx context.Context, tourID int32) ([]GiamGiaTour, error) {
	rows, err := q.db.Query(ctx, getDiscountsByTourID, tourID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GiamGiaTour
	for rows.Next() {
		var i GiamGiaTour
		if err := rows.Scan(
			&i.ID,
			&i.TourID,
			&i.PhanTram,
			&i.NgayBatDau,
			&i.NgayKetThuc,
			&i.NgayTao,
			&i.NgayCapNhat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getFeaturedTours = `-- name: GetFeaturedTours :many
SELECT
  t.id,
  t.tieu_de,
  t.mo_ta,
  t.so_ngay,
  t.so_dem,
  t.gia_nguoi_lon,
  t.gia_tre_em,
  t.don_vi_tien_te,
  dm.ten AS danh_muc_ten,
  (
    SELECT a.duong_dan
    FROM anh_tour a
    WHERE a.tour_id = t.id AND a.la_anh_chinh = true
    LIMIT 1
  ) AS anh_chinh,
  COALESCE(AVG(dg.diem_danh_gia), 0) as avg_rating,
  COUNT(dg.id) as total_reviews
FROM tour t
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN danh_gia dg ON t.id = dg.tour_id AND dg.dang_hoat_dong = true
WHERE t.noi_bat = true AND t.dang_hoat_dong = true
GROUP BY t.id, dm.ten
ORDER BY t.ngay_tao DESC
LIMIT $1
`

type GetFeaturedToursRow struct {
	ID           int32          `json:"id"`
	TieuDe       string         `json:"tieu_de"`
	MoTa         *string        `json:"mo_ta"`
	SoNgay       int32          `json:"so_ngay"`
	SoDem        int32          `json:"so_dem"`
	GiaNguoiLon  pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm     pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe  *string        `json:"don_vi_tien_te"`
	DanhMucTen   *string        `json:"danh_muc_ten"`
	AnhChinh     string         `json:"anh_chinh"`
	AvgRating    interface{}    `json:"avg_rating"`
	TotalReviews int64          `json:"total_reviews"`
}

func (q *Queries) GetFeaturedTours(ctx context.Context, limit int32) ([]GetFeaturedToursRow, error) {
	rows, err := q.db.Query(ctx, getFeaturedTours, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetFeaturedToursRow
	for rows.Next() {
		var i GetFeaturedToursRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.DanhMucTen,
			&i.AnhChinh,
			&i.AvgRating,
			&i.TotalReviews,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTourDestinations = `-- name: GetTourDestinations :many
SELECT 
    dd.id, dd.ten, dd.tinh, dd.quoc_gia, dd.khu_vuc, dd.iso2, dd.iso3, dd.mo_ta, dd.anh, dd.vi_do, dd.kinh_do, dd.ngay_tao, dd.ngay_cap_nhat,
    td.thu_tu_tham_quan
FROM tour_diem_den td
JOIN diem_den dd ON td.diem_den_id = dd.id
WHERE td.tour_id = $1
ORDER BY td.thu_tu_tham_quan ASC NULLS LAST
`

type GetTourDestinationsRow struct {
	ID            int32            `json:"id"`
	Ten           string           `json:"ten"`
	Tinh          *string          `json:"tinh"`
	QuocGia       *string          `json:"quoc_gia"`
	KhuVuc        *string          `json:"khu_vuc"`
	Iso2          *string          `json:"iso2"`
	Iso3          *string          `json:"iso3"`
	MoTa          *string          `json:"mo_ta"`
	Anh           *string          `json:"anh"`
	ViDo          pgtype.Numeric   `json:"vi_do"`
	KinhDo        pgtype.Numeric   `json:"kinh_do"`
	NgayTao       pgtype.Timestamp `json:"ngay_tao"`
	NgayCapNhat   pgtype.Timestamp `json:"ngay_cap_nhat"`
	ThuTuThamQuan *int32           `json:"thu_tu_tham_quan"`
}

func (q *Queries) GetTourDestinations(ctx context.Context, tourID int32) ([]GetTourDestinationsRow, error) {
	rows, err := q.db.Query(ctx, getTourDestinations, tourID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTourDestinationsRow
	for rows.Next() {
		var i GetTourDestinationsRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Tinh,
			&i.QuocGia,
			&i.KhuVuc,
			&i.Iso2,
			&i.Iso3,
			&i.MoTa,
			&i.Anh,
			&i.ViDo,
			&i.KinhDo,
			&i.NgayTao,
			&i.NgayCapNhat,
			&i.ThuTuThamQuan,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTourDetailByID = `-- name: GetTourDetailByID :one
WITH tour_info AS (
    -- Thông tin cơ bản tour
    SELECT 
        t.id,
        t.tieu_de,
        t.mo_ta,
        t.so_ngay,
        t.so_dem,
        t.gia_nguoi_lon,
        t.gia_tre_em,
        t.don_vi_tien_te,
        t.trang_thai,
        t.noi_bat,
        t.ngay_tao,
        t.ngay_cap_nhat,
        dm.ten as ten_danh_muc,
        ncc.ten as ten_nha_cung_cap,
        ncc.logo as logo_ncc
    FROM tour t
    LEFT JOIN danh_muc_tour dm ON t.danh_muc_id = dm.id
    LEFT JOIN nha_cung_cap ncc ON t.nha_cung_cap_id = ncc.id
    WHERE t.id = $1
),
tour_images AS (
    -- Ảnh tour
    SELECT 
        tour_id,
        json_agg(
            json_build_object(
                'id', id,
                'duong_dan', duong_dan,
                'mo_ta', mo_ta,
                'la_anh_chinh', la_anh_chinh,
                'thu_tu_hien_thi', thu_tu_hien_thi
            ) ORDER BY thu_tu_hien_thi, la_anh_chinh DESC
        ) as images
    FROM anh_tour
    WHERE tour_id = $1
    GROUP BY tour_id
),
tour_destinations AS (
    -- Điểm đến
    SELECT 
        tdd.tour_id,
        json_agg(
            json_build_object(
                'id', dd.id,
                'ten', dd.ten,
                'tinh', dd.tinh,
                'quoc_gia', dd.quoc_gia,
                'khu_vuc', dd.khu_vuc,
                'mo_ta', dd.mo_ta,
                'anh', dd.anh,
                'vi_do', dd.vi_do,
                'kinh_do', dd.kinh_do,
                'thu_tu_tham_quan', tdd.thu_tu_tham_quan
            ) ORDER BY tdd.thu_tu_tham_quan
        ) as destinations
    FROM tour_diem_den tdd
    INNER JOIN diem_den dd ON tdd.diem_den_id = dd.id
    WHERE tdd.tour_id = $1
    GROUP BY tdd.tour_id
),
tour_itinerary AS (
    -- Lịch trình và hoạt động
    SELECT 
        ltt.tour_id,
        json_agg(
            json_build_object(
                'id', ltt.id,
                'ngay_thu', ltt.ngay_thu,
                'tieu_de', ltt.tieu_de,
                'mo_ta', ltt.mo_ta,
                'gio_bat_dau', ltt.gio_bat_dau,
                'gio_ket_thuc', ltt.gio_ket_thuc,
                'dia_diem', ltt.dia_diem,
                'thong_tin_luu_tru', ltt.thong_tin_luu_tru,
                'hoat_dong', (
                    SELECT json_agg(
                        json_build_object(
                            'id', hdlt.id,
                            'ten', hdlt.ten,
                            'gio_bat_dau', hdlt.gio_bat_dau,
                            'gio_ket_thuc', hdlt.gio_ket_thuc,
                            'mo_ta', hdlt.mo_ta,
                            'thu_tu', hdlt.thu_tu
                        ) ORDER BY hdlt.thu_tu
                    )
                    FROM hoat_dong_trong_ngay hdlt
                    WHERE hdlt.lich_trinh_id = ltt.id
                )
            ) ORDER BY ltt.ngay_thu
        ) as itinerary
    FROM lich_trinh ltt
    WHERE ltt.tour_id = $1
    GROUP BY ltt.tour_id
),
tour_departures AS (
    -- Lịch khởi hành
    SELECT 
        tour_id,
        json_agg(
            json_build_object(
                'id', id,
                'ngay_khoi_hanh', ngay_khoi_hanh,
                'ngay_ket_thuc', ngay_ket_thuc,
                'suc_chua', suc_chua,
                'trang_thai', trang_thai,
                'ghi_chu', ghi_chu,
                'so_cho_da_dat', so_cho_da_dat
            ) ORDER BY ngay_khoi_hanh
        ) as departures
    FROM khoi_hanh_tour
    WHERE tour_id = $1
    AND ngay_khoi_hanh >= CURRENT_DATE
    AND trang_thai IN ('len_lich', 'xac_nhan', 'con_cho')
    GROUP BY tour_id
),
tour_discount AS (
    -- Giảm giá hiện tại
    SELECT 
        tour_id,
        phan_tram,
        ngay_bat_dau,
        ngay_ket_thuc
    FROM giam_gia_tour
    WHERE tour_id = $1
    AND CURRENT_DATE BETWEEN ngay_bat_dau AND ngay_ket_thuc
    ORDER BY phan_tram DESC
    LIMIT 1
),
tour_config AS (
    -- Cấu hình nhóm
    SELECT 
        tour_id,
        so_nho_nhat,
        so_lon_nhat
    FROM cau_hinh_nhom_tour
    WHERE tour_id = $1
)
SELECT 
    ti.id, ti.tieu_de, ti.mo_ta, ti.so_ngay, ti.so_dem, ti.gia_nguoi_lon, ti.gia_tre_em, ti.don_vi_tien_te, ti.trang_thai, ti.noi_bat, ti.ngay_tao, ti.ngay_cap_nhat, ti.ten_danh_muc, ti.ten_nha_cung_cap, ti.logo_ncc,
    COALESCE(timg.images, '[]'::json) as images,
    COALESCE(td.destinations, '[]'::json) as destinations,
    COALESCE(tit.itinerary, '[]'::json) as itinerary,
    COALESCE(tdep.departures, '[]'::json) as departures,
    tdisc.phan_tram as giam_gia_phan_tram,
    tdisc.ngay_bat_dau as giam_gia_tu,
    tdisc.ngay_ket_thuc as giam_gia_den,
    tc.so_nho_nhat,
    tc.so_lon_nhat
FROM tour_info ti
LEFT JOIN tour_images timg ON ti.id = timg.tour_id
LEFT JOIN tour_destinations td ON ti.id = td.tour_id
LEFT JOIN tour_itinerary tit ON ti.id = tit.tour_id
LEFT JOIN tour_departures tdep ON ti.id = tdep.tour_id
LEFT JOIN tour_discount tdisc ON ti.id = tdisc.tour_id
LEFT JOIN tour_config tc ON ti.id = tc.tour_id
`

type GetTourDetailByIDRow struct {
	ID              int32            `json:"id"`
	TieuDe          string           `json:"tieu_de"`
	MoTa            *string          `json:"mo_ta"`
	SoNgay          int32            `json:"so_ngay"`
	SoDem           int32            `json:"so_dem"`
	GiaNguoiLon     pgtype.Numeric   `json:"gia_nguoi_lon"`
	GiaTreEm        pgtype.Numeric   `json:"gia_tre_em"`
	DonViTienTe     *string          `json:"don_vi_tien_te"`
	TrangThai       *string          `json:"trang_thai"`
	NoiBat          *bool            `json:"noi_bat"`
	NgayTao         pgtype.Timestamp `json:"ngay_tao"`
	NgayCapNhat     pgtype.Timestamp `json:"ngay_cap_nhat"`
	TenDanhMuc      *string          `json:"ten_danh_muc"`
	TenNhaCungCap   *string          `json:"ten_nha_cung_cap"`
	LogoNcc         *string          `json:"logo_ncc"`
	Images          []byte           `json:"images"`
	Destinations    []byte           `json:"destinations"`
	Itinerary       []byte           `json:"itinerary"`
	Departures      []byte           `json:"departures"`
	GiamGiaPhanTram pgtype.Numeric   `json:"giam_gia_phan_tram"`
	GiamGiaTu       pgtype.Date      `json:"giam_gia_tu"`
	GiamGiaDen      pgtype.Date      `json:"giam_gia_den"`
	SoNhoNhat       *int32           `json:"so_nho_nhat"`
	SoLonNhat       *int32           `json:"so_lon_nhat"`
}

func (q *Queries) GetTourDetailByID(ctx context.Context, id int32) (GetTourDetailByIDRow, error) {
	row := q.db.QueryRow(ctx, getTourDetailByID, id)
	var i GetTourDetailByIDRow
	err := row.Scan(
		&i.ID,
		&i.TieuDe,
		&i.MoTa,
		&i.SoNgay,
		&i.SoDem,
		&i.GiaNguoiLon,
		&i.GiaTreEm,
		&i.DonViTienTe,
		&i.TrangThai,
		&i.NoiBat,
		&i.NgayTao,
		&i.NgayCapNhat,
		&i.TenDanhMuc,
		&i.TenNhaCungCap,
		&i.LogoNcc,
		&i.Images,
		&i.Destinations,
		&i.Itinerary,
		&i.Departures,
		&i.GiamGiaPhanTram,
		&i.GiamGiaTu,
		&i.GiamGiaDen,
		&i.SoNhoNhat,
		&i.SoLonNhat,
	)
	return i, err
}

const getTourImages = `-- name: GetTourImages :many
SELECT id, tour_id, duong_dan, mo_ta, la_anh_chinh, thu_tu_hien_thi, ngay_tao FROM anh_tour
WHERE tour_id = $1
ORDER BY 
    la_anh_chinh DESC NULLS LAST,
    thu_tu_hien_thi ASC NULLS LAST,
    id ASC
`

func (q *Queries) GetTourImages(ctx context.Context, tourID int32) ([]AnhTour, error) {
	rows, err := q.db.Query(ctx, getTourImages, tourID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AnhTour
	for rows.Next() {
		var i AnhTour
		if err := rows.Scan(
			&i.ID,
			&i.TourID,
			&i.DuongDan,
			&i.MoTa,
			&i.LaAnhChinh,
			&i.ThuTuHienThi,
			&i.NgayTao,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getToursByCategoryFilter = `-- name: GetToursByCategoryFilter :many
SELECT
  t.id,
  t.tieu_de,
  t.mo_ta,
  t.so_ngay,
  t.so_dem,
  t.gia_nguoi_lon,
  t.gia_tre_em,
  t.don_vi_tien_te,
  (
    SELECT a.duong_dan
    FROM anh_tour a
    WHERE a.tour_id = t.id AND a.la_anh_chinh = true
    LIMIT 1
  ) AS anh_chinh
FROM tour t
WHERE t.danh_muc_id = $1 AND t.dang_hoat_dong = true
ORDER BY t.noi_bat DESC, t.ngay_tao DESC
LIMIT $2 OFFSET $3
`

type GetToursByCategoryFilterParams struct {
	DanhMucID *int32 `json:"danh_muc_id"`
	Limit     int32  `json:"limit"`
	Offset    int32  `json:"offset"`
}

type GetToursByCategoryFilterRow struct {
	ID          int32          `json:"id"`
	TieuDe      string         `json:"tieu_de"`
	MoTa        *string        `json:"mo_ta"`
	SoNgay      int32          `json:"so_ngay"`
	SoDem       int32          `json:"so_dem"`
	GiaNguoiLon pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm    pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe *string        `json:"don_vi_tien_te"`
	AnhChinh    string         `json:"anh_chinh"`
}

func (q *Queries) GetToursByCategoryFilter(ctx context.Context, arg GetToursByCategoryFilterParams) ([]GetToursByCategoryFilterRow, error) {
	rows, err := q.db.Query(ctx, getToursByCategoryFilter, arg.DanhMucID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetToursByCategoryFilterRow
	for rows.Next() {
		var i GetToursByCategoryFilterRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.AnhChinh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getToursBySupplier = `-- name: GetToursBySupplier :many
SELECT id, tieu_de, mo_ta, danh_muc_id, so_ngay, so_dem, gia_nguoi_lon, gia_tre_em, don_vi_tien_te, trang_thai, noi_bat, nha_cung_cap_id, dang_hoat_dong, ngay_tao, ngay_cap_nhat FROM tour
WHERE nha_cung_cap_id = $1
ORDER BY ngay_tao DESC
LIMIT $2 OFFSET $3
`

type GetToursBySupplierParams struct {
	NhaCungCapID pgtype.UUID `json:"nha_cung_cap_id"`
	Limit        int32       `json:"limit"`
	Offset       int32       `json:"offset"`
}

func (q *Queries) GetToursBySupplier(ctx context.Context, arg GetToursBySupplierParams) ([]Tour, error) {
	rows, err := q.db.Query(ctx, getToursBySupplier, arg.NhaCungCapID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Tour
	for rows.Next() {
		var i Tour
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.NhaCungCapID,
			&i.DangHoatDong,
			&i.NgayTao,
			&i.NgayCapNhat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const searchTours = `-- name: SearchTours :many

WITH tour_info AS (
  -- Lấy thông tin cơ bản của Tour và tính toán giá sau giảm
  SELECT
    t.id, t.tieu_de, t.mo_ta, t.danh_muc_id, t.so_ngay, t.so_dem, t.gia_nguoi_lon, t.gia_tre_em, 
    t.don_vi_tien_te, t.trang_thai, t.noi_bat, t.ngay_tao,
    dm.ten AS danh_muc_ten, 
    ncc.ten AS nha_cung_cap_ten,
    -- Subquery lấy Ảnh Chính
    (
      SELECT a.duong_dan FROM anh_tour a 
      WHERE a.tour_id = t.id
      ORDER BY COALESCE(a.la_anh_chinh, FALSE) DESC, COALESCE(a.thu_tu_hien_thi, 0) ASC LIMIT 1
    ) AS anh_chinh
  FROM tour t
  LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
  LEFT JOIN nha_cung_cap ncc ON ncc.id = t.nha_cung_cap_id
  WHERE t.dang_hoat_dong = TRUE -- Lọc Tour đang hoạt động
),
dd AS (
  -- Tổng hợp Điểm đến thành mảng (diem_den)
  SELECT td.tour_id, array_agg(DISTINCT d.ten ORDER BY d.ten) AS diem_den
  FROM tour_diem_den td
  JOIN diem_den d ON d.id = td.diem_den_id
  GROUP BY td.tour_id
),
dg AS (
  -- Tính điểm Đánh giá trung bình và Tổng số đánh giá
  SELECT tour_id, AVG(diem_danh_gia)::FLOAT AS avg_rating, COUNT(*)::INT AS total_reviews
  FROM danh_gia
  WHERE dang_hoat_dong = TRUE
  GROUP BY tour_id
),
kh AS (
  -- Tìm Ngày Khởi hành gần nhất và hợp lệ
  SELECT
    tour_id,
    MIN(ngay_khoi_hanh) FILTER (WHERE ngay_khoi_hanh >= CURRENT_DATE AND trang_thai IN ('len_lich','xac_nhan','con_cho')) AS next_departure_date
  FROM khoi_hanh_tour
  GROUP BY tour_id
),
ggt AS (
  -- Tìm Mức Giảm giá cao nhất đang có hiệu lực
  SELECT DISTINCT ON (tour_id)
    tour_id, 
    phan_tram,
    ngay_bat_dau AS giam_gia_tu,
    ngay_ket_thuc AS giam_gia_den
  FROM giam_gia_tour
  WHERE CURRENT_DATE BETWEEN ngay_bat_dau AND ngay_ket_thuc
  ORDER BY tour_id, phan_tram DESC -- Lấy giảm giá % cao nhất
),
search_keyword_match AS (
    -- Lọc Tour theo Từ khóa (trong Tiêu đề HOẶC Hoạt động/Lịch trình)
    SELECT ti.id AS tour_id FROM tour_info ti
    WHERE $3::TEXT IS NOT NULL AND (
        to_tsvector('vietnamese', ti.tieu_de) @@ plainto_tsquery('vietnamese', $3)
        OR EXISTS (
            SELECT 1 FROM lich_trinh lt
            JOIN hoat_dong_trong_ngay hd ON hd.lich_trinh_id = lt.id
            WHERE lt.tour_id = ti.id AND to_tsvector('vietnamese', hd.ten) @@ plainto_tsquery('vietnamese', $3)
        )
    )
),
search_destination_name_match AS (
    -- Lọc Tour theo Tên điểm đến/Tỉnh/Quốc gia (tối ưu hóa việc lọc)
    SELECT tdd.tour_id FROM tour_diem_den tdd
    JOIN diem_den d ON d.id = tdd.diem_den_id
    WHERE $4::TEXT IS NOT NULL 
      AND (
          -- Sử dụng unaccent/lower để tìm kiếm linh hoạt (Cần Index gin_trgm trên cột này để tối ưu)
          unaccent(lower(d.ten)) LIKE '%' || unaccent(lower($4)) || '%'
          OR unaccent(lower(d.tinh)) LIKE '%' || unaccent(lower($4)) || '%'
          OR unaccent(lower(d.quoc_gia)) LIKE '%' || unaccent(lower($4)) || '%'
      )
    GROUP BY tdd.tour_id
)
SELECT
  ti.id, ti.tieu_de, ti.mo_ta, ti.danh_muc_id, ti.so_ngay, ti.so_dem, ti.gia_nguoi_lon, ti.gia_tre_em, ti.don_vi_tien_te,
  ti.trang_thai, ti.noi_bat, ti.danh_muc_ten, ti.nha_cung_cap_ten, ti.anh_chinh,
  
  dd.diem_den, -- Thông tin Điểm đến
  COALESCE(dg.avg_rating, 0) AS avg_rating, -- Đánh giá
  COALESCE(dg.total_reviews, 0) AS total_reviews,
  kh.next_departure_date, -- Ngày khởi hành gần nhất
  
  ggt.phan_tram AS giam_gia_phan_tram, -- Giảm giá
  ggt.giam_gia_tu,
  ggt.giam_gia_den,

  -- Tính giá sau giảm cho Người lớn
  CASE 
    WHEN ggt.phan_tram IS NOT NULL THEN 
      ROUND(ti.gia_nguoi_lon * (1 - ggt.phan_tram / 100), 2)
    ELSE ti.gia_nguoi_lon
  END AS gia_sau_giam_nguoi_lon,
  -- Tính giá sau giảm cho Trẻ em
  CASE 
    WHEN ggt.phan_tram IS NOT NULL THEN 
      ROUND(ti.gia_tre_em * (1 - ggt.phan_tram / 100), 2)
    ELSE ti.gia_tre_em
  END AS gia_sau_giam_tre_em

FROM tour_info ti
LEFT JOIN dd ON dd.tour_id = ti.id
LEFT JOIN dg ON dg.tour_id = ti.id
LEFT JOIN kh ON kh.tour_id = ti.id
LEFT JOIN ggt ON ggt.tour_id = ti.id
LEFT JOIN search_keyword_match sm ON sm.tour_id = ti.id
LEFT JOIN search_destination_name_match dnm ON dnm.tour_id = ti.id

WHERE 
  -- Lọc theo Keyword
  ($3::TEXT IS NULL OR sm.tour_id IS NOT NULL)
  -- Lọc theo Điểm đến (Tên)
  AND ($4::TEXT IS NULL OR dnm.tour_id IS NOT NULL)
  -- Lọc theo Điểm đến (ID)
  AND (
    $5::INT IS NULL 
    OR EXISTS (
      SELECT 1 FROM tour_diem_den tdd WHERE tdd.tour_id = ti.id AND tdd.diem_den_id = $5
    )
  )
  -- Lọc theo Số ngày
  AND ($6::INT IS NULL OR ti.so_ngay >= $6)
  AND ($7::INT IS NULL OR ti.so_ngay <= $7)
  -- Lọc theo Số đêm  
  AND ($8::INT IS NULL OR ti.so_dem >= $8)
  AND ($9::INT IS NULL OR ti.so_dem <= $9)

ORDER BY ti.noi_bat DESC, ti.ngay_tao DESC
LIMIT $1 OFFSET $2
`

type SearchToursParams struct {
	Limit      int32   `json:"limit"`
	Offset     int32   `json:"offset"`
	Keyword    *string `json:"keyword"`
	DiemDenTen *string `json:"diem_den_ten"`
	DiemDenID  *int32  `json:"diem_den_id"`
	SoNgayMin  *int32  `json:"so_ngay_min"`
	SoNgayMax  *int32  `json:"so_ngay_max"`
	SoDemMin   *int32  `json:"so_dem_min"`
	SoDemMax   *int32  `json:"so_dem_max"`
}

type SearchToursRow struct {
	ID                 int32          `json:"id"`
	TieuDe             string         `json:"tieu_de"`
	MoTa               *string        `json:"mo_ta"`
	DanhMucID          *int32         `json:"danh_muc_id"`
	SoNgay             int32          `json:"so_ngay"`
	SoDem              int32          `json:"so_dem"`
	GiaNguoiLon        pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm           pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe        *string        `json:"don_vi_tien_te"`
	TrangThai          *string        `json:"trang_thai"`
	NoiBat             *bool          `json:"noi_bat"`
	DanhMucTen         *string        `json:"danh_muc_ten"`
	NhaCungCapTen      *string        `json:"nha_cung_cap_ten"`
	AnhChinh           string         `json:"anh_chinh"`
	DiemDen            interface{}    `json:"diem_den"`
	AvgRating          float64        `json:"avg_rating"`
	TotalReviews       int32          `json:"total_reviews"`
	NextDepartureDate  interface{}    `json:"next_departure_date"`
	GiamGiaPhanTram    pgtype.Numeric `json:"giam_gia_phan_tram"`
	GiamGiaTu          pgtype.Date    `json:"giam_gia_tu"`
	GiamGiaDen         pgtype.Date    `json:"giam_gia_den"`
	GiaSauGiamNguoiLon interface{}    `json:"gia_sau_giam_nguoi_lon"`
	GiaSauGiamTreEm    interface{}    `json:"gia_sau_giam_tre_em"`
}

// Đảm bảo bạn đã định nghĩa các CTE cần thiết (dd, dg, kh, ggt) như trong các bước trước.
// Tôi sẽ gộp CTE tổng hợp thông tin tour cơ bản vào tour_info.
// Câu truy vấn Chính: Tổng hợp tất cả thông tin và áp dụng các bộ lọc
// LEFT JOIN các bộ lọc để áp dụng WHERE
func (q *Queries) SearchTours(ctx context.Context, arg SearchToursParams) ([]SearchToursRow, error) {
	rows, err := q.db.Query(ctx, searchTours,
		arg.Limit,
		arg.Offset,
		arg.Keyword,
		arg.DiemDenTen,
		arg.DiemDenID,
		arg.SoNgayMin,
		arg.SoNgayMax,
		arg.SoDemMin,
		arg.SoDemMax,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []SearchToursRow
	for rows.Next() {
		var i SearchToursRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.NhaCungCapTen,
			&i.AnhChinh,
			&i.DiemDen,
			&i.AvgRating,
			&i.TotalReviews,
			&i.NextDepartureDate,
			&i.GiamGiaPhanTram,
			&i.GiamGiaTu,
			&i.GiamGiaDen,
			&i.GiaSauGiamNguoiLon,
			&i.GiaSauGiamTreEm,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const setPrimaryTourImage = `-- name: SetPrimaryTourImage :exec
UPDATE anh_tour
SET la_anh_chinh = (id = $2)
WHERE tour_id = $1
`

type SetPrimaryTourImageParams struct {
	TourID int32 `json:"tour_id"`
	ID     int32 `json:"id"`
}

func (q *Queries) SetPrimaryTourImage(ctx context.Context, arg SetPrimaryTourImageParams) error {
	_, err := q.db.Exec(ctx, setPrimaryTourImage, arg.TourID, arg.ID)
	return err
}

const toggleTourActive = `-- name: ToggleTourActive :one

UPDATE tour
SET 
    dang_hoat_dong = NOT dang_hoat_dong,
    ngay_cap_nhat = NOW()
WHERE id = $1
RETURNING id, tieu_de, mo_ta, danh_muc_id, so_ngay, so_dem, gia_nguoi_lon, gia_tre_em, don_vi_tien_te, trang_thai, noi_bat, nha_cung_cap_id, dang_hoat_dong, ngay_tao, ngay_cap_nhat
`

func (q *Queries) ToggleTourActive(ctx context.Context, id int32) (Tour, error) {
	row := q.db.QueryRow(ctx, toggleTourActive, id)
	var i Tour
	err := row.Scan(
		&i.ID,
		&i.TieuDe,
		&i.MoTa,
		&i.DanhMucID,
		&i.SoNgay,
		&i.SoDem,
		&i.GiaNguoiLon,
		&i.GiaTreEm,
		&i.DonViTienTe,
		&i.TrangThai,
		&i.NoiBat,
		&i.NhaCungCapID,
		&i.DangHoatDong,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const updateDiscountTour = `-- name: UpdateDiscountTour :one
UPDATE giam_gia_tour
SET
    tour_id = COALESCE($2, tour_id),
    phan_tram = COALESCE($3, phan_tram),
    ngay_bat_dau = COALESCE($4, ngay_bat_dau),
    ngay_ket_thuc = COALESCE($5, ngay_ket_thuc),
    ngay_cap_nhat = NOW()
WHERE id = $1 AND tour_id = $2
RETURNING id, tour_id, phan_tram, ngay_bat_dau, ngay_ket_thuc, ngay_tao, ngay_cap_nhat
`

type UpdateDiscountTourParams struct {
	ID          int32          `json:"id"`
	TourID      int32          `json:"tour_id"`
	PhanTram    pgtype.Numeric `json:"phan_tram"`
	NgayBatDau  pgtype.Date    `json:"ngay_bat_dau"`
	NgayKetThuc pgtype.Date    `json:"ngay_ket_thuc"`
}

func (q *Queries) UpdateDiscountTour(ctx context.Context, arg UpdateDiscountTourParams) (GiamGiaTour, error) {
	row := q.db.QueryRow(ctx, updateDiscountTour,
		arg.ID,
		arg.TourID,
		arg.PhanTram,
		arg.NgayBatDau,
		arg.NgayKetThuc,
	)
	var i GiamGiaTour
	err := row.Scan(
		&i.ID,
		&i.TourID,
		&i.PhanTram,
		&i.NgayBatDau,
		&i.NgayKetThuc,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const updateTour = `-- name: UpdateTour :one
UPDATE tour
SET 
    tieu_de = COALESCE($2, tieu_de),
    mo_ta = COALESCE($3, mo_ta),
    danh_muc_id = COALESCE($4, danh_muc_id),
    so_ngay = COALESCE($5, so_ngay),
    so_dem = COALESCE($6, so_dem),
    gia_nguoi_lon = COALESCE($7, gia_nguoi_lon),
    gia_tre_em = COALESCE($8, gia_tre_em),
    don_vi_tien_te = COALESCE($9, don_vi_tien_te),
    trang_thai = COALESCE($10, trang_thai),
    noi_bat = COALESCE($11, noi_bat),
    nha_cung_cap_id = COALESCE($12, nha_cung_cap_id),
    dang_hoat_dong = COALESCE($13, dang_hoat_dong),
    ngay_cap_nhat = NOW()
WHERE id = $1
RETURNING id, tieu_de, mo_ta, danh_muc_id, so_ngay, so_dem, gia_nguoi_lon, gia_tre_em, don_vi_tien_te, trang_thai, noi_bat, nha_cung_cap_id, dang_hoat_dong, ngay_tao, ngay_cap_nhat
`

type UpdateTourParams struct {
	ID           int32          `json:"id"`
	TieuDe       *string        `json:"tieu_de"`
	MoTa         *string        `json:"mo_ta"`
	DanhMucID    *int32         `json:"danh_muc_id"`
	SoNgay       *int32         `json:"so_ngay"`
	SoDem        *int32         `json:"so_dem"`
	GiaNguoiLon  pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm     pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe  *string        `json:"don_vi_tien_te"`
	TrangThai    *string        `json:"trang_thai"`
	NoiBat       *bool          `json:"noi_bat"`
	NhaCungCapID pgtype.UUID    `json:"nha_cung_cap_id"`
	DangHoatDong *bool          `json:"dang_hoat_dong"`
}

func (q *Queries) UpdateTour(ctx context.Context, arg UpdateTourParams) (Tour, error) {
	row := q.db.QueryRow(ctx, updateTour,
		arg.ID,
		arg.TieuDe,
		arg.MoTa,
		arg.DanhMucID,
		arg.SoNgay,
		arg.SoDem,
		arg.GiaNguoiLon,
		arg.GiaTreEm,
		arg.DonViTienTe,
		arg.TrangThai,
		arg.NoiBat,
		arg.NhaCungCapID,
		arg.DangHoatDong,
	)
	var i Tour
	err := row.Scan(
		&i.ID,
		&i.TieuDe,
		&i.MoTa,
		&i.DanhMucID,
		&i.SoNgay,
		&i.SoDem,
		&i.GiaNguoiLon,
		&i.GiaTreEm,
		&i.DonViTienTe,
		&i.TrangThai,
		&i.NoiBat,
		&i.NhaCungCapID,
		&i.DangHoatDong,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const updateTourImage = `-- name: UpdateTourImage :one
UPDATE anh_tour
SET 
    duong_dan = COALESCE($3, duong_dan),
    mo_ta = COALESCE($4, mo_ta),
    la_anh_chinh = COALESCE($5, la_anh_chinh),
    thu_tu_hien_thi = COALESCE($6, thu_tu_hien_thi)
WHERE id = $1 AND tour_id = $2
RETURNING id, tour_id, duong_dan, mo_ta, la_anh_chinh, thu_tu_hien_thi, ngay_tao
`

type UpdateTourImageParams struct {
	ID           int32   `json:"id"`
	TourID       int32   `json:"tour_id"`
	DuongDan     *string `json:"duong_dan"`
	MoTa         *string `json:"mo_ta"`
	LaAnhChinh   *bool   `json:"la_anh_chinh"`
	ThuTuHienThi *int32  `json:"thu_tu_hien_thi"`
}

func (q *Queries) UpdateTourImage(ctx context.Context, arg UpdateTourImageParams) (AnhTour, error) {
	row := q.db.QueryRow(ctx, updateTourImage,
		arg.ID,
		arg.TourID,
		arg.DuongDan,
		arg.MoTa,
		arg.LaAnhChinh,
		arg.ThuTuHienThi,
	)
	var i AnhTour
	err := row.Scan(
		&i.ID,
		&i.TourID,
		&i.DuongDan,
		&i.MoTa,
		&i.LaAnhChinh,
		&i.ThuTuHienThi,
		&i.NgayTao,
	)
	return i, err
}
