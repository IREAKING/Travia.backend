// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: recommendation.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
	"github.com/pgvector/pgvector-go"
)

const createTourEmbedding = `-- name: CreateTourEmbedding :one
INSERT INTO tour_embeddings (
    tour_id,
    embedding
) VALUES (
    $1, $2
)
ON CONFLICT (tour_id)
DO UPDATE SET 
    embedding = EXCLUDED.embedding,
    ngay_cap_nhat = NOW()
RETURNING tour_id, embedding, ngay_tao, ngay_cap_nhat
`

type CreateTourEmbeddingParams struct {
	TourID    int32            `json:"tour_id"`
	Embedding *pgvector.Vector `json:"embedding"`
}

// Tạo hoặc cập nhật embedding cho tour
func (q *Queries) CreateTourEmbedding(ctx context.Context, arg CreateTourEmbeddingParams) (TourEmbedding, error) {
	row := q.db.QueryRow(ctx, createTourEmbedding, arg.TourID, arg.Embedding)
	var i TourEmbedding
	err := row.Scan(
		&i.TourID,
		&i.Embedding,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const createTourViewHistory = `-- name: CreateTourViewHistory :one

INSERT INTO lich_su_xem_tour (
    nguoi_dung_id,
    tour_id,
    thoi_gian_xem,
    thoi_luong_xem_giay,
    ip_address,
    user_agent
) VALUES (
    $1, $2, $3, $4, $5, $6
) RETURNING id, nguoi_dung_id, tour_id, thoi_gian_xem, thoi_luong_xem_giay, ip_address, user_agent
`

type CreateTourViewHistoryParams struct {
	NguoiDungID      pgtype.UUID      `json:"nguoi_dung_id"`
	TourID           *int32           `json:"tour_id"`
	ThoiGianXem      pgtype.Timestamp `json:"thoi_gian_xem"`
	ThoiLuongXemGiay *int32           `json:"thoi_luong_xem_giay"`
	IpAddress        *string          `json:"ip_address"`
	UserAgent        *string          `json:"user_agent"`
}

// ===========================================
// QUERIES CHO AI GỢI Ý TOUR
// ===========================================
// Lưu lịch sử xem tour
func (q *Queries) CreateTourViewHistory(ctx context.Context, arg CreateTourViewHistoryParams) (LichSuXemTour, error) {
	row := q.db.QueryRow(ctx, createTourViewHistory,
		arg.NguoiDungID,
		arg.TourID,
		arg.ThoiGianXem,
		arg.ThoiLuongXemGiay,
		arg.IpAddress,
		arg.UserAgent,
	)
	var i LichSuXemTour
	err := row.Scan(
		&i.ID,
		&i.NguoiDungID,
		&i.TourID,
		&i.ThoiGianXem,
		&i.ThoiLuongXemGiay,
		&i.IpAddress,
		&i.UserAgent,
	)
	return i, err
}

const getMostViewedTours = `-- name: GetMostViewedTours :many
SELECT 
    tour_id,
    COUNT(*) as so_luot_xem,
    AVG(thoi_luong_xem_giay) as thoi_luong_xem_trung_binh
FROM lich_su_xem_tour
WHERE thoi_gian_xem >= NOW() - INTERVAL '30 days'
GROUP BY tour_id
ORDER BY so_luot_xem DESC, thoi_luong_xem_trung_binh DESC
LIMIT $1
`

type GetMostViewedToursRow struct {
	TourID                *int32  `json:"tour_id"`
	SoLuotXem             int64   `json:"so_luot_xem"`
	ThoiLuongXemTrungBinh float64 `json:"thoi_luong_xem_trung_binh"`
}

// Lấy các tour được xem nhiều nhất
func (q *Queries) GetMostViewedTours(ctx context.Context, limit int32) ([]GetMostViewedToursRow, error) {
	rows, err := q.db.Query(ctx, getMostViewedTours, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetMostViewedToursRow
	for rows.Next() {
		var i GetMostViewedToursRow
		if err := rows.Scan(&i.TourID, &i.SoLuotXem, &i.ThoiLuongXemTrungBinh); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRecommendedToursByFavoriteDestinations = `-- name: GetRecommendedToursByFavoriteDestinations :many
WITH SoThichKhachHang AS (
    -- Tìm các địa danh (diem_den) mà khách hàng đã từng đặt hoặc yêu thích
    SELECT DISTINCT dd.id as diem_den_id
    FROM tour_yeu_thich tyf
    JOIN tour_diem_den tdd ON tyf.tour_id = tdd.tour_id
    JOIN diem_den dd ON tdd.diem_den_id = dd.id
    WHERE tyf.nguoi_dung_id = $1
    UNION
    SELECT DISTINCT dd.id as diem_den_id
    FROM dat_cho dc
    JOIN khoi_hanh_tour kh ON dc.khoi_hanh_id = kh.id
    JOIN tour_diem_den tdd ON kh.tour_id = tdd.tour_id
    JOIN diem_den dd ON tdd.diem_den_id = dd.id
    WHERE dc.nguoi_dung_id = $1
)
SELECT 
    t.id,
    t.tieu_de,
    t.mo_ta,
    t.danh_muc_id,
    t.so_ngay,
    t.so_dem,
    t.gia_nguoi_lon,
    t.gia_tre_em,
    t.don_vi_tien_te,
    t.trang_thai,
    t.noi_bat,
    dm.ten AS danh_muc_ten,
    ncc.ten AS nha_cung_cap_ten,
    (
        SELECT a.duong_dan
        FROM anh_tour a
        WHERE a.tour_id = t.id
        ORDER BY COALESCE(a.la_anh_chinh, false) DESC, COALESCE(a.thu_tu_hien_thi, 0) ASC, a.id ASC
        LIMIT 1
    ) AS anh_chinh,
    COUNT(tdd.diem_den_id) as do_phu_hop,
    COALESCE(dg.avg_rating, 0) as avg_rating,
    COALESCE(dg.total_reviews, 0) as total_reviews
FROM tour t
JOIN tour_diem_den tdd ON t.id = tdd.tour_id
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN nha_cung_cap ncc ON ncc.id = t.nha_cung_cap_id
LEFT JOIN (
    SELECT tour_id, AVG(diem_danh_gia)::float AS avg_rating, COUNT(*)::int AS total_reviews
    FROM danh_gia
    WHERE dang_hoat_dong = TRUE
    GROUP BY tour_id
) dg ON dg.tour_id = t.id
WHERE tdd.diem_den_id IN (SELECT diem_den_id FROM SoThichKhachHang)
  AND t.dang_hoat_dong = TRUE
  AND t.trang_thai = 'cong_bo'
GROUP BY t.id, t.tieu_de, t.mo_ta, t.danh_muc_id, t.so_ngay, t.so_dem, 
         t.gia_nguoi_lon, t.gia_tre_em, t.don_vi_tien_te, t.trang_thai, 
         t.noi_bat, dm.ten, ncc.ten, dg.avg_rating, dg.total_reviews
ORDER BY do_phu_hop DESC, t.noi_bat DESC, avg_rating DESC
LIMIT $2 OFFSET $3
`

type GetRecommendedToursByFavoriteDestinationsParams struct {
	NguoiDungID pgtype.UUID `json:"nguoi_dung_id"`
	Limit       int32       `json:"limit"`
	Offset      int32       `json:"offset"`
}

type GetRecommendedToursByFavoriteDestinationsRow struct {
	ID            int32          `json:"id"`
	TieuDe        string         `json:"tieu_de"`
	MoTa          *string        `json:"mo_ta"`
	DanhMucID     *int32         `json:"danh_muc_id"`
	SoNgay        int32          `json:"so_ngay"`
	SoDem         int32          `json:"so_dem"`
	GiaNguoiLon   pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm      pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe   *string        `json:"don_vi_tien_te"`
	TrangThai     *string        `json:"trang_thai"`
	NoiBat        *bool          `json:"noi_bat"`
	DanhMucTen    *string        `json:"danh_muc_ten"`
	NhaCungCapTen *string        `json:"nha_cung_cap_ten"`
	AnhChinh      string         `json:"anh_chinh"`
	DoPhuHop      int64          `json:"do_phu_hop"`
	AvgRating     float64        `json:"avg_rating"`
	TotalReviews  int32          `json:"total_reviews"`
}

// Gợi ý tour dựa trên các điểm đến mà người dùng đã yêu thích
func (q *Queries) GetRecommendedToursByFavoriteDestinations(ctx context.Context, arg GetRecommendedToursByFavoriteDestinationsParams) ([]GetRecommendedToursByFavoriteDestinationsRow, error) {
	rows, err := q.db.Query(ctx, getRecommendedToursByFavoriteDestinations, arg.NguoiDungID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetRecommendedToursByFavoriteDestinationsRow
	for rows.Next() {
		var i GetRecommendedToursByFavoriteDestinationsRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.NhaCungCapTen,
			&i.AnhChinh,
			&i.DoPhuHop,
			&i.AvgRating,
			&i.TotalReviews,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRecommendedToursByPreferences = `-- name: GetRecommendedToursByPreferences :many
SELECT 
    t.id,
    t.tieu_de,
    t.mo_ta,
    t.danh_muc_id,
    t.so_ngay,
    t.so_dem,
    t.gia_nguoi_lon,
    t.gia_tre_em,
    t.don_vi_tien_te,
    t.trang_thai,
    t.noi_bat,
    dm.ten AS danh_muc_ten,
    ncc.ten AS nha_cung_cap_ten,
    (
        SELECT a.duong_dan
        FROM anh_tour a
        WHERE a.tour_id = t.id
        ORDER BY COALESCE(a.la_anh_chinh, false) DESC, COALESCE(a.thu_tu_hien_thi, 0) ASC, a.id ASC
        LIMIT 1
    ) AS anh_chinh,
    COALESCE(SUM(st.diem_so), 0) as tong_diem_so_thich,
    COALESCE(dg.avg_rating, 0) as avg_rating,
    COALESCE(dg.total_reviews, 0) as total_reviews
FROM tour t
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN nha_cung_cap ncc ON ncc.id = t.nha_cung_cap_id
LEFT JOIN so_thich_nguoi_dung st ON (
    (st.loai_so_thich = 'danh_muc' AND st.gia_tri_id = t.danh_muc_id)
    OR (st.loai_so_thich = 'diem_den' AND st.gia_tri_id IN (
        SELECT diem_den_id FROM tour_diem_den WHERE tour_id = t.id
    ))
) AND st.nguoi_dung_id = $1
LEFT JOIN (
    SELECT tour_id, AVG(diem_danh_gia)::float AS avg_rating, COUNT(*)::int AS total_reviews
    FROM danh_gia
    WHERE dang_hoat_dong = TRUE
    GROUP BY tour_id
) dg ON dg.tour_id = t.id
WHERE t.dang_hoat_dong = TRUE 
    AND t.trang_thai = 'cong_bo'
    AND ($1::uuid IS NULL OR st.nguoi_dung_id IS NOT NULL)
GROUP BY t.id, t.tieu_de, t.mo_ta, t.danh_muc_id, t.so_ngay, t.so_dem, 
         t.gia_nguoi_lon, t.gia_tre_em, t.don_vi_tien_te, t.trang_thai, 
         t.noi_bat, dm.ten, ncc.ten, dg.avg_rating, dg.total_reviews
ORDER BY tong_diem_so_thich DESC, t.noi_bat DESC, avg_rating DESC, t.ngay_tao DESC
LIMIT $2 OFFSET $3
`

type GetRecommendedToursByPreferencesParams struct {
	NguoiDungID pgtype.UUID `json:"nguoi_dung_id"`
	Limit       int32       `json:"limit"`
	Offset      int32       `json:"offset"`
}

type GetRecommendedToursByPreferencesRow struct {
	ID              int32          `json:"id"`
	TieuDe          string         `json:"tieu_de"`
	MoTa            *string        `json:"mo_ta"`
	DanhMucID       *int32         `json:"danh_muc_id"`
	SoNgay          int32          `json:"so_ngay"`
	SoDem           int32          `json:"so_dem"`
	GiaNguoiLon     pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm        pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe     *string        `json:"don_vi_tien_te"`
	TrangThai       *string        `json:"trang_thai"`
	NoiBat          *bool          `json:"noi_bat"`
	DanhMucTen      *string        `json:"danh_muc_ten"`
	NhaCungCapTen   *string        `json:"nha_cung_cap_ten"`
	AnhChinh        string         `json:"anh_chinh"`
	TongDiemSoThich interface{}    `json:"tong_diem_so_thich"`
	AvgRating       float64        `json:"avg_rating"`
	TotalReviews    int32          `json:"total_reviews"`
}

// Gợi ý tour dựa trên sở thích người dùng (danh mục và điểm đến)
func (q *Queries) GetRecommendedToursByPreferences(ctx context.Context, arg GetRecommendedToursByPreferencesParams) ([]GetRecommendedToursByPreferencesRow, error) {
	rows, err := q.db.Query(ctx, getRecommendedToursByPreferences, arg.NguoiDungID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetRecommendedToursByPreferencesRow
	for rows.Next() {
		var i GetRecommendedToursByPreferencesRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.NhaCungCapTen,
			&i.AnhChinh,
			&i.TongDiemSoThich,
			&i.AvgRating,
			&i.TotalReviews,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRecommendedToursByViewHistory = `-- name: GetRecommendedToursByViewHistory :many
SELECT 
    t.id,
    t.tieu_de,
    t.mo_ta,
    t.danh_muc_id,
    t.so_ngay,
    t.so_dem,
    t.gia_nguoi_lon,
    t.gia_tre_em,
    t.don_vi_tien_te,
    t.trang_thai,
    t.noi_bat,
    dm.ten AS danh_muc_ten,
    ncc.ten AS nha_cung_cap_ten,
    (
        SELECT a.duong_dan
        FROM anh_tour a
        WHERE a.tour_id = t.id
        ORDER BY COALESCE(a.la_anh_chinh, false) DESC, COALESCE(a.thu_tu_hien_thi, 0) ASC, a.id ASC
        LIMIT 1
    ) AS anh_chinh,
    AVG(lsx.thoi_luong_xem_giay) as thoi_luong_xem_trung_binh,
    COUNT(lsx.id) as so_lan_xem,
    COALESCE(dg.avg_rating, 0) as avg_rating,
    COALESCE(dg.total_reviews, 0) as total_reviews
FROM tour t
JOIN lich_su_xem_tour lsx ON t.id = lsx.tour_id
LEFT JOIN danh_muc_tour dm ON dm.id = t.danh_muc_id
LEFT JOIN nha_cung_cap ncc ON ncc.id = t.nha_cung_cap_id
LEFT JOIN (
    SELECT tour_id, AVG(diem_danh_gia)::float AS avg_rating, COUNT(*)::int AS total_reviews
    FROM danh_gia
    WHERE dang_hoat_dong = TRUE
    GROUP BY tour_id
) dg ON dg.tour_id = t.id
WHERE lsx.nguoi_dung_id = $1
  AND t.dang_hoat_dong = TRUE
  AND t.trang_thai = 'cong_bo'
  AND lsx.thoi_luong_xem_giay > 30 -- Chỉ lấy tour xem hơn 30 giây
GROUP BY t.id, t.tieu_de, t.mo_ta, t.danh_muc_id, t.so_ngay, t.so_dem, 
         t.gia_nguoi_lon, t.gia_tre_em, t.don_vi_tien_te, t.trang_thai, 
         t.noi_bat, dm.ten, ncc.ten, dg.avg_rating, dg.total_reviews
ORDER BY thoi_luong_xem_trung_binh DESC, so_lan_xem DESC, t.noi_bat DESC
LIMIT $2 OFFSET $3
`

type GetRecommendedToursByViewHistoryParams struct {
	NguoiDungID pgtype.UUID `json:"nguoi_dung_id"`
	Limit       int32       `json:"limit"`
	Offset      int32       `json:"offset"`
}

type GetRecommendedToursByViewHistoryRow struct {
	ID                    int32          `json:"id"`
	TieuDe                string         `json:"tieu_de"`
	MoTa                  *string        `json:"mo_ta"`
	DanhMucID             *int32         `json:"danh_muc_id"`
	SoNgay                int32          `json:"so_ngay"`
	SoDem                 int32          `json:"so_dem"`
	GiaNguoiLon           pgtype.Numeric `json:"gia_nguoi_lon"`
	GiaTreEm              pgtype.Numeric `json:"gia_tre_em"`
	DonViTienTe           *string        `json:"don_vi_tien_te"`
	TrangThai             *string        `json:"trang_thai"`
	NoiBat                *bool          `json:"noi_bat"`
	DanhMucTen            *string        `json:"danh_muc_ten"`
	NhaCungCapTen         *string        `json:"nha_cung_cap_ten"`
	AnhChinh              string         `json:"anh_chinh"`
	ThoiLuongXemTrungBinh float64        `json:"thoi_luong_xem_trung_binh"`
	SoLanXem              int64          `json:"so_lan_xem"`
	AvgRating             float64        `json:"avg_rating"`
	TotalReviews          int32          `json:"total_reviews"`
}

// Gợi ý tour dựa trên lịch sử xem (ưu tiên tour xem lâu)
func (q *Queries) GetRecommendedToursByViewHistory(ctx context.Context, arg GetRecommendedToursByViewHistoryParams) ([]GetRecommendedToursByViewHistoryRow, error) {
	rows, err := q.db.Query(ctx, getRecommendedToursByViewHistory, arg.NguoiDungID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetRecommendedToursByViewHistoryRow
	for rows.Next() {
		var i GetRecommendedToursByViewHistoryRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.MoTa,
			&i.DanhMucID,
			&i.SoNgay,
			&i.SoDem,
			&i.GiaNguoiLon,
			&i.GiaTreEm,
			&i.DonViTienTe,
			&i.TrangThai,
			&i.NoiBat,
			&i.DanhMucTen,
			&i.NhaCungCapTen,
			&i.AnhChinh,
			&i.ThoiLuongXemTrungBinh,
			&i.SoLanXem,
			&i.AvgRating,
			&i.TotalReviews,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getSimilarToursByEmbedding = `-- name: GetSimilarToursByEmbedding :many
SELECT 
    tour_id,
    1 - (embedding <=> $1) as do_tuong_dong
FROM tour_embeddings
WHERE tour_id != $2
ORDER BY embedding <=> $1
LIMIT $3
`

type GetSimilarToursByEmbeddingParams struct {
	Embedding *pgvector.Vector `json:"embedding"`
	TourID    int32            `json:"tour_id"`
	Limit     int32            `json:"limit"`
}

type GetSimilarToursByEmbeddingRow struct {
	TourID      int32 `json:"tour_id"`
	DoTuongDong int32 `json:"do_tuong_dong"`
}

// Tìm các tour tương tự dựa trên embedding (semantic search)
func (q *Queries) GetSimilarToursByEmbedding(ctx context.Context, arg GetSimilarToursByEmbeddingParams) ([]GetSimilarToursByEmbeddingRow, error) {
	rows, err := q.db.Query(ctx, getSimilarToursByEmbedding, arg.Embedding, arg.TourID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetSimilarToursByEmbeddingRow
	for rows.Next() {
		var i GetSimilarToursByEmbeddingRow
		if err := rows.Scan(&i.TourID, &i.DoTuongDong); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTourEmbedding = `-- name: GetTourEmbedding :one
SELECT tour_id, embedding, ngay_tao, ngay_cap_nhat FROM tour_embeddings
WHERE tour_id = $1
`

// Lấy embedding của một tour
func (q *Queries) GetTourEmbedding(ctx context.Context, tourID int32) (TourEmbedding, error) {
	row := q.db.QueryRow(ctx, getTourEmbedding, tourID)
	var i TourEmbedding
	err := row.Scan(
		&i.TourID,
		&i.Embedding,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const getTourViewHistoryByTour = `-- name: GetTourViewHistoryByTour :many
SELECT id, nguoi_dung_id, tour_id, thoi_gian_xem, thoi_luong_xem_giay, ip_address, user_agent FROM lich_su_xem_tour
WHERE tour_id = $1
ORDER BY thoi_gian_xem DESC
LIMIT $2 OFFSET $3
`

type GetTourViewHistoryByTourParams struct {
	TourID *int32 `json:"tour_id"`
	Limit  int32  `json:"limit"`
	Offset int32  `json:"offset"`
}

// Lấy lịch sử xem của một tour cụ thể
func (q *Queries) GetTourViewHistoryByTour(ctx context.Context, arg GetTourViewHistoryByTourParams) ([]LichSuXemTour, error) {
	rows, err := q.db.Query(ctx, getTourViewHistoryByTour, arg.TourID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []LichSuXemTour
	for rows.Next() {
		var i LichSuXemTour
		if err := rows.Scan(
			&i.ID,
			&i.NguoiDungID,
			&i.TourID,
			&i.ThoiGianXem,
			&i.ThoiLuongXemGiay,
			&i.IpAddress,
			&i.UserAgent,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTourViewHistoryByUser = `-- name: GetTourViewHistoryByUser :many
SELECT id, nguoi_dung_id, tour_id, thoi_gian_xem, thoi_luong_xem_giay, ip_address, user_agent FROM lich_su_xem_tour
WHERE nguoi_dung_id = $1
ORDER BY thoi_gian_xem DESC
LIMIT $2 OFFSET $3
`

type GetTourViewHistoryByUserParams struct {
	NguoiDungID pgtype.UUID `json:"nguoi_dung_id"`
	Limit       int32       `json:"limit"`
	Offset      int32       `json:"offset"`
}

// Lấy lịch sử xem tour của người dùng
func (q *Queries) GetTourViewHistoryByUser(ctx context.Context, arg GetTourViewHistoryByUserParams) ([]LichSuXemTour, error) {
	rows, err := q.db.Query(ctx, getTourViewHistoryByUser, arg.NguoiDungID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []LichSuXemTour
	for rows.Next() {
		var i LichSuXemTour
		if err := rows.Scan(
			&i.ID,
			&i.NguoiDungID,
			&i.TourID,
			&i.ThoiGianXem,
			&i.ThoiLuongXemGiay,
			&i.IpAddress,
			&i.UserAgent,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getUserPreferences = `-- name: GetUserPreferences :many
SELECT nguoi_dung_id, loai_so_thich, gia_tri_id, diem_so, ngay_cap_nhat FROM so_thich_nguoi_dung
WHERE nguoi_dung_id = $1
ORDER BY diem_so DESC, ngay_cap_nhat DESC
`

// Lấy sở thích của người dùng
func (q *Queries) GetUserPreferences(ctx context.Context, nguoiDungID pgtype.UUID) ([]SoThichNguoiDung, error) {
	rows, err := q.db.Query(ctx, getUserPreferences, nguoiDungID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []SoThichNguoiDung
	for rows.Next() {
		var i SoThichNguoiDung
		if err := rows.Scan(
			&i.NguoiDungID,
			&i.LoaiSoThich,
			&i.GiaTriID,
			&i.DiemSo,
			&i.NgayCapNhat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getUserPreferencesByType = `-- name: GetUserPreferencesByType :many
SELECT nguoi_dung_id, loai_so_thich, gia_tri_id, diem_so, ngay_cap_nhat FROM so_thich_nguoi_dung
WHERE nguoi_dung_id = $1 AND loai_so_thich = $2
ORDER BY diem_so DESC, ngay_cap_nhat DESC
`

type GetUserPreferencesByTypeParams struct {
	NguoiDungID pgtype.UUID `json:"nguoi_dung_id"`
	LoaiSoThich string      `json:"loai_so_thich"`
}

// Lấy sở thích theo loại (danh_muc hoặc diem_den)
func (q *Queries) GetUserPreferencesByType(ctx context.Context, arg GetUserPreferencesByTypeParams) ([]SoThichNguoiDung, error) {
	rows, err := q.db.Query(ctx, getUserPreferencesByType, arg.NguoiDungID, arg.LoaiSoThich)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []SoThichNguoiDung
	for rows.Next() {
		var i SoThichNguoiDung
		if err := rows.Scan(
			&i.NguoiDungID,
			&i.LoaiSoThich,
			&i.GiaTriID,
			&i.DiemSo,
			&i.NgayCapNhat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateTourViewDuration = `-- name: UpdateTourViewDuration :one
UPDATE lich_su_xem_tour
SET thoi_luong_xem_giay = $3
WHERE id = $1 AND tour_id = $2
RETURNING id, nguoi_dung_id, tour_id, thoi_gian_xem, thoi_luong_xem_giay, ip_address, user_agent
`

type UpdateTourViewDurationParams struct {
	ID               int32  `json:"id"`
	TourID           *int32 `json:"tour_id"`
	ThoiLuongXemGiay *int32 `json:"thoi_luong_xem_giay"`
}

// Cập nhật thời lượng xem khi người dùng rời khỏi trang
func (q *Queries) UpdateTourViewDuration(ctx context.Context, arg UpdateTourViewDurationParams) (LichSuXemTour, error) {
	row := q.db.QueryRow(ctx, updateTourViewDuration, arg.ID, arg.TourID, arg.ThoiLuongXemGiay)
	var i LichSuXemTour
	err := row.Scan(
		&i.ID,
		&i.NguoiDungID,
		&i.TourID,
		&i.ThoiGianXem,
		&i.ThoiLuongXemGiay,
		&i.IpAddress,
		&i.UserAgent,
	)
	return i, err
}
