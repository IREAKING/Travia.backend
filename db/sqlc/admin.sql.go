// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: admin.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const adminChartBookingStatusStats = `-- name: AdminChartBookingStatusStats :many
SELECT 
    trang_thai,
    COUNT(*) AS so_luong,
    SUM(tong_tien)::numeric AS gia_tri_uoc_tinh
FROM dat_cho
WHERE 
    ($1::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $1::int)
    AND ($2::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $2::int)
GROUP BY trang_thai
`

type AdminChartBookingStatusStatsParams struct {
	Nam   int32 `json:"nam"`
	Thang int32 `json:"thang"`
}

type AdminChartBookingStatusStatsRow struct {
	TrangThai     NullTrangThaiDatCho `json:"trang_thai"`
	SoLuong       int64               `json:"so_luong"`
	GiaTriUocTinh pgtype.Numeric      `json:"gia_tri_uoc_tinh"`
}

// Trạng thái Đặt chỗ
func (q *Queries) AdminChartBookingStatusStats(ctx context.Context, arg AdminChartBookingStatusStatsParams) ([]AdminChartBookingStatusStatsRow, error) {
	rows, err := q.db.Query(ctx, adminChartBookingStatusStats, arg.Nam, arg.Thang)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AdminChartBookingStatusStatsRow
	for rows.Next() {
		var i AdminChartBookingStatusStatsRow
		if err := rows.Scan(&i.TrangThai, &i.SoLuong, &i.GiaTriUocTinh); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const adminChartCategoryDistribution = `-- name: AdminChartCategoryDistribution :many
SELECT 
    dm.ten AS ten_danh_muc,
    COUNT(dc.id) AS so_luong_dat,
    COALESCE(SUM(dc.tong_tien), 0)::numeric AS tong_doanh_thu
FROM dat_cho dc
JOIN khoi_hanh_tour kh ON dc.khoi_hanh_id = kh.id
JOIN tour t ON kh.tour_id = t.id
JOIN danh_muc_tour dm ON t.danh_muc_id = dm.id
WHERE 
    ($1::int = 0 OR EXTRACT(YEAR FROM dc.ngay_dat)::int = $1::int)
    AND ($2::int = 0 OR EXTRACT(MONTH FROM dc.ngay_dat)::int = $2::int)
    AND dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY dm.id, dm.ten
ORDER BY tong_doanh_thu DESC
`

type AdminChartCategoryDistributionParams struct {
	Nam   int32 `json:"nam"`
	Thang int32 `json:"thang"`
}

type AdminChartCategoryDistributionRow struct {
	TenDanhMuc   string         `json:"ten_danh_muc"`
	SoLuongDat   int64          `json:"so_luong_dat"`
	TongDoanhThu pgtype.Numeric `json:"tong_doanh_thu"`
}

// Cơ cấu Doanh thu theo Danh mục
func (q *Queries) AdminChartCategoryDistribution(ctx context.Context, arg AdminChartCategoryDistributionParams) ([]AdminChartCategoryDistributionRow, error) {
	rows, err := q.db.Query(ctx, adminChartCategoryDistribution, arg.Nam, arg.Thang)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AdminChartCategoryDistributionRow
	for rows.Next() {
		var i AdminChartCategoryDistributionRow
		if err := rows.Scan(&i.TenDanhMuc, &i.SoLuongDat, &i.TongDoanhThu); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const adminChartRevenueTrend = `-- name: AdminChartRevenueTrend :many
SELECT 
    DATE(ngay_dat) AS ngay,
    COUNT(id) AS tong_so_don,
    COALESCE(SUM(tong_tien), 0) AS doanh_thu_ngay,
    COALESCE(SUM(so_nguoi_lon + so_tre_em), 0) AS tong_khach_ngay
FROM dat_cho
WHERE 
    ($1::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $1::int)
    AND ($2::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $2::int)
    AND trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY DATE(ngay_dat)
ORDER BY ngay ASC
`

type AdminChartRevenueTrendParams struct {
	Nam   int32 `json:"nam"`
	Thang int32 `json:"thang"`
}

type AdminChartRevenueTrendRow struct {
	Ngay          pgtype.Date `json:"ngay"`
	TongSoDon     int64       `json:"tong_so_don"`
	DoanhThuNgay  interface{} `json:"doanh_thu_ngay"`
	TongKhachNgay interface{} `json:"tong_khach_ngay"`
}

// Xu hướng Doanh thu & Đặt chỗ
func (q *Queries) AdminChartRevenueTrend(ctx context.Context, arg AdminChartRevenueTrendParams) ([]AdminChartRevenueTrendRow, error) {
	rows, err := q.db.Query(ctx, adminChartRevenueTrend, arg.Nam, arg.Thang)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AdminChartRevenueTrendRow
	for rows.Next() {
		var i AdminChartRevenueTrendRow
		if err := rows.Scan(
			&i.Ngay,
			&i.TongSoDon,
			&i.DoanhThuNgay,
			&i.TongKhachNgay,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const adminChartTopSuppliers = `-- name: AdminChartTopSuppliers :many
SELECT 
    ncc.ten AS ten_nha_cung_cap,
    COUNT(dc.id) AS so_don_hang,
    COALESCE(SUM(dc.tong_tien), 0)::numeric AS doanh_thu_dat_duoc
FROM dat_cho dc
JOIN khoi_hanh_tour kh ON dc.khoi_hanh_id = kh.id
JOIN tour t ON kh.tour_id = t.id
JOIN nha_cung_cap ncc ON t.nha_cung_cap_id = ncc.id
WHERE 
    ($1::int = 0 OR EXTRACT(YEAR FROM dc.ngay_dat)::int = $1::int)
    AND ($2::int = 0 OR EXTRACT(MONTH FROM dc.ngay_dat)::int = $2::int)
    AND dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY ncc.id, ncc.ten
ORDER BY doanh_thu_dat_duoc DESC
LIMIT 5
`

type AdminChartTopSuppliersParams struct {
	Nam   int32 `json:"nam"`
	Thang int32 `json:"thang"`
}

type AdminChartTopSuppliersRow struct {
	TenNhaCungCap   string         `json:"ten_nha_cung_cap"`
	SoDonHang       int64          `json:"so_don_hang"`
	DoanhThuDatDuoc pgtype.Numeric `json:"doanh_thu_dat_duoc"`
}

// Top 5 Nhà cung cấp xuất sắc
func (q *Queries) AdminChartTopSuppliers(ctx context.Context, arg AdminChartTopSuppliersParams) ([]AdminChartTopSuppliersRow, error) {
	rows, err := q.db.Query(ctx, adminChartTopSuppliers, arg.Nam, arg.Thang)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AdminChartTopSuppliersRow
	for rows.Next() {
		var i AdminChartTopSuppliersRow
		if err := rows.Scan(&i.TenNhaCungCap, &i.SoDonHang, &i.DoanhThuDatDuoc); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const adminCustomerGrowthMonthlyReport = `-- name: AdminCustomerGrowthMonthlyReport :many
WITH MonthlyStats AS (
    SELECT 
        EXTRACT(YEAR FROM ngay_tao)::int AS nam,
        EXTRACT(MONTH FROM ngay_tao)::int AS thang,
        COUNT(id) AS so_luong
    FROM nguoi_dung
    WHERE vai_tro = 'khach_hang' 
      AND dang_hoat_dong = TRUE
    GROUP BY 1, 2
)
SELECT 
    nam,
    thang,
    so_luong AS khach_moi_thang_nay,
    COALESCE(LAG(so_luong) OVER (ORDER BY nam, thang), 0) AS khach_moi_thang_truoc,
    -- Tính % tăng trưởng
    ROUND(
        CASE 
            WHEN LAG(so_luong) OVER (ORDER BY nam, thang) IS NULL OR LAG(so_luong) OVER (ORDER BY nam, thang) = 0 THEN 100
            ELSE ((so_luong - LAG(so_luong) OVER (ORDER BY nam, thang))::float / LAG(so_luong) OVER (ORDER BY nam, thang) * 100)
        END::numeric, 2
    ) AS phan_tram_tang_truong
FROM MonthlyStats
WHERE ($1::int = 0 OR nam = $1::int)
ORDER BY nam DESC, thang DESC
`

type AdminCustomerGrowthMonthlyReportRow struct {
	Nam                int32          `json:"nam"`
	Thang              int32          `json:"thang"`
	KhachMoiThangNay   int64          `json:"khach_moi_thang_nay"`
	KhachMoiThangTruoc interface{}    `json:"khach_moi_thang_truoc"`
	PhanTramTangTruong pgtype.Numeric `json:"phan_tram_tang_truong"`
}

func (q *Queries) AdminCustomerGrowthMonthlyReport(ctx context.Context, nam int32) ([]AdminCustomerGrowthMonthlyReportRow, error) {
	rows, err := q.db.Query(ctx, adminCustomerGrowthMonthlyReport, nam)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AdminCustomerGrowthMonthlyReportRow
	for rows.Next() {
		var i AdminCustomerGrowthMonthlyReportRow
		if err := rows.Scan(
			&i.Nam,
			&i.Thang,
			&i.KhachMoiThangNay,
			&i.KhachMoiThangTruoc,
			&i.PhanTramTangTruong,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const approveSupplier = `-- name: ApproveSupplier :one
UPDATE nguoi_dung
SET 
    dang_hoat_dong = TRUE,
    xac_thuc = TRUE,
    ngay_cap_nhat = CURRENT_TIMESTAMP
WHERE id = $1 
    AND vai_tro = 'nha_cung_cap'
    AND dang_hoat_dong = TRUE
RETURNING id, ho_ten, email, mat_khau_ma_hoa, so_dien_thoai, vai_tro, dang_hoat_dong, xac_thuc, ngay_tao, ngay_cap_nhat
`

// phê duyệt nhà cung cấp
func (q *Queries) ApproveSupplier(ctx context.Context, id pgtype.UUID) (NguoiDung, error) {
	row := q.db.QueryRow(ctx, approveSupplier, id)
	var i NguoiDung
	err := row.Scan(
		&i.ID,
		&i.HoTen,
		&i.Email,
		&i.MatKhauMaHoa,
		&i.SoDienThoai,
		&i.VaiTro,
		&i.DangHoatDong,
		&i.XacThuc,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const deleteSupplier = `-- name: DeleteSupplier :exec
DELETE FROM nha_cung_cap
WHERE id = $1 AND nha_cung_cap.dang_hoat_dong = TRUE
`

func (q *Queries) DeleteSupplier(ctx context.Context, id pgtype.UUID) error {
	_, err := q.db.Exec(ctx, deleteSupplier, id)
	return err
}

const getAdminSupplierByID = `-- name: GetAdminSupplierByID :one
SELECT ncc.id, ncc.ten, ncc.dia_chi, ncc.website, ncc.mo_ta, ncc.logo, ncc.nam_thanh_lap, ncc.thanh_pho, ncc.quoc_gia, ncc.ma_so_thue, ncc.so_nhan_vien, ncc.giay_to_kinh_doanh, nd.ho_ten, nd.email, nd.so_dien_thoai, nd.ngay_tao, nd.ngay_cap_nhat, nd.dang_hoat_dong, nd.xac_thuc
FROM nha_cung_cap ncc
JOIN nguoi_dung nd ON nd.id = ncc.id
WHERE ncc.id = $1
`

type GetAdminSupplierByIDRow struct {
	ID              pgtype.UUID      `json:"id"`
	Ten             string           `json:"ten"`
	DiaChi          *string          `json:"dia_chi"`
	Website         *string          `json:"website"`
	MoTa            *string          `json:"mo_ta"`
	Logo            *string          `json:"logo"`
	NamThanhLap     pgtype.Date      `json:"nam_thanh_lap"`
	ThanhPho        *string          `json:"thanh_pho"`
	QuocGia         *string          `json:"quoc_gia"`
	MaSoThue        *string          `json:"ma_so_thue"`
	SoNhanVien      *string          `json:"so_nhan_vien"`
	GiayToKinhDoanh *string          `json:"giay_to_kinh_doanh"`
	HoTen           string           `json:"ho_ten"`
	Email           string           `json:"email"`
	SoDienThoai     *string          `json:"so_dien_thoai"`
	NgayTao         pgtype.Timestamp `json:"ngay_tao"`
	NgayCapNhat     pgtype.Timestamp `json:"ngay_cap_nhat"`
	DangHoatDong    *bool            `json:"dang_hoat_dong"`
	XacThuc         *bool            `json:"xac_thuc"`
}

// Lấy nhà cung cấp theo ID (admin)
func (q *Queries) GetAdminSupplierByID(ctx context.Context, id pgtype.UUID) (GetAdminSupplierByIDRow, error) {
	row := q.db.QueryRow(ctx, getAdminSupplierByID, id)
	var i GetAdminSupplierByIDRow
	err := row.Scan(
		&i.ID,
		&i.Ten,
		&i.DiaChi,
		&i.Website,
		&i.MoTa,
		&i.Logo,
		&i.NamThanhLap,
		&i.ThanhPho,
		&i.QuocGia,
		&i.MaSoThue,
		&i.SoNhanVien,
		&i.GiayToKinhDoanh,
		&i.HoTen,
		&i.Email,
		&i.SoDienThoai,
		&i.NgayTao,
		&i.NgayCapNhat,
		&i.DangHoatDong,
		&i.XacThuc,
	)
	return i, err
}

const getAllSuppliers = `-- name: GetAllSuppliers :many
SELECT ncc.id, ncc.ten, ncc.dia_chi, ncc.website, ncc.mo_ta, ncc.logo, ncc.nam_thanh_lap, ncc.thanh_pho, ncc.quoc_gia, ncc.ma_so_thue, ncc.so_nhan_vien, ncc.giay_to_kinh_doanh, nd.ho_ten, nd.email, nd.so_dien_thoai, nd.ngay_tao, nd.xac_thuc, nd.dang_hoat_dong
FROM nha_cung_cap ncc
JOIN nguoi_dung nd ON nd.id = ncc.id
WHERE 
  ($1::boolean IS NULL OR nd.xac_thuc = $1)
  AND ($2::boolean IS NULL OR nd.dang_hoat_dong = $2)
ORDER BY nd.ngay_tao DESC
`

type GetAllSuppliersParams struct {
	XacThuc      *bool `json:"xac_thuc"`
	DangHoatDong *bool `json:"dang_hoat_dong"`
}

type GetAllSuppliersRow struct {
	ID              pgtype.UUID      `json:"id"`
	Ten             string           `json:"ten"`
	DiaChi          *string          `json:"dia_chi"`
	Website         *string          `json:"website"`
	MoTa            *string          `json:"mo_ta"`
	Logo            *string          `json:"logo"`
	NamThanhLap     pgtype.Date      `json:"nam_thanh_lap"`
	ThanhPho        *string          `json:"thanh_pho"`
	QuocGia         *string          `json:"quoc_gia"`
	MaSoThue        *string          `json:"ma_so_thue"`
	SoNhanVien      *string          `json:"so_nhan_vien"`
	GiayToKinhDoanh *string          `json:"giay_to_kinh_doanh"`
	HoTen           string           `json:"ho_ten"`
	Email           string           `json:"email"`
	SoDienThoai     *string          `json:"so_dien_thoai"`
	NgayTao         pgtype.Timestamp `json:"ngay_tao"`
	XacThuc         *bool            `json:"xac_thuc"`
	DangHoatDong    *bool            `json:"dang_hoat_dong"`
}

// =====================================Nhà cung cấp=====================================
func (q *Queries) GetAllSuppliers(ctx context.Context, arg GetAllSuppliersParams) ([]GetAllSuppliersRow, error) {
	rows, err := q.db.Query(ctx, getAllSuppliers, arg.XacThuc, arg.DangHoatDong)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetAllSuppliersRow
	for rows.Next() {
		var i GetAllSuppliersRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.DiaChi,
			&i.Website,
			&i.MoTa,
			&i.Logo,
			&i.NamThanhLap,
			&i.ThanhPho,
			&i.QuocGia,
			&i.MaSoThue,
			&i.SoNhanVien,
			&i.GiayToKinhDoanh,
			&i.HoTen,
			&i.Email,
			&i.SoDienThoai,
			&i.NgayTao,
			&i.XacThuc,
			&i.DangHoatDong,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getBookingsByDayOfWeek = `-- name: GetBookingsByDayOfWeek :many
SELECT 
    EXTRACT(DOW FROM ngay_dat) AS ngay_trong_tuan,
    CASE EXTRACT(DOW FROM ngay_dat)
        WHEN 0 THEN 'Chủ nhật'
        WHEN 1 THEN 'Thứ hai'
        WHEN 2 THEN 'Thứ ba'
        WHEN 3 THEN 'Thứ tư'
        WHEN 4 THEN 'Thứ năm'
        WHEN 5 THEN 'Thứ sáu'
        WHEN 6 THEN 'Thứ bảy'
    END AS ten_ngay,
    COUNT(*) AS so_booking,
    COALESCE(SUM(tong_tien), 0) AS doanh_thu
FROM dat_cho
WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY EXTRACT(DOW FROM ngay_dat)
ORDER BY ngay_trong_tuan
`

type GetBookingsByDayOfWeekRow struct {
	NgayTrongTuan pgtype.Numeric `json:"ngay_trong_tuan"`
	TenNgay       interface{}    `json:"ten_ngay"`
	SoBooking     int64          `json:"so_booking"`
	DoanhThu      interface{}    `json:"doanh_thu"`
}

// Thống kê booking theo ngày trong tuần
func (q *Queries) GetBookingsByDayOfWeek(ctx context.Context) ([]GetBookingsByDayOfWeekRow, error) {
	rows, err := q.db.Query(ctx, getBookingsByDayOfWeek)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetBookingsByDayOfWeekRow
	for rows.Next() {
		var i GetBookingsByDayOfWeekRow
		if err := rows.Scan(
			&i.NgayTrongTuan,
			&i.TenNgay,
			&i.SoBooking,
			&i.DoanhThu,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDashboardOverview = `-- name: GetDashboardOverview :one
SELECT
(SELECT COUNT(*) FROM nguoi_dung WHERE dang_hoat_dong = TRUE) AS tong_nguoi_dung,
(SELECT COUNT(*) FROM nguoi_dung WHERE dang_hoat_dong = TRUE AND vai_tro = 'khach_hang') AS tong_khach_hang,
(SELECT COUNT(*) FROM nha_cung_cap) AS tong_nha_cung_cap,
(SELECT COUNT(*) FROM tour WHERE dang_hoat_dong = TRUE) AS tong_tour,
(SELECT COUNT(*) FROM tour WHERE dang_hoat_dong = TRUE AND trang_thai = 'cong_bo') AS tour_dang_hoat_dong,
(SELECT COUNT(*) FROM dat_cho) AS tong_dat_cho,
(SELECT COUNT(*) FROM dat_cho WHERE trang_thai = 'da_thanh_toan') AS dat_cho_da_thanh_toan,
(SELECT COALESCE(SUM(tong_tien), 0) FROM dat_cho WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')) AS tong_doanh_thu,
(SELECT COALESCE(SUM(tong_tien), 0) FROM dat_cho
WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')
AND DATE_TRUNC('month', ngay_dat) = DATE_TRUNC('month', CURRENT_DATE)) AS doanh_thu_thang_nay,
(SELECT COUNT(*) FROM danh_gia WHERE dang_hoat_dong = TRUE) AS tong_danh_gia,
(SELECT COALESCE(AVG(diem_danh_gia), 0) FROM danh_gia WHERE dang_hoat_dong = TRUE) AS diem_danh_gia_trung_binh
`

type GetDashboardOverviewRow struct {
	TongNguoiDung        int64       `json:"tong_nguoi_dung"`
	TongKhachHang        int64       `json:"tong_khach_hang"`
	TongNhaCungCap       int64       `json:"tong_nha_cung_cap"`
	TongTour             int64       `json:"tong_tour"`
	TourDangHoatDong     int64       `json:"tour_dang_hoat_dong"`
	TongDatCho           int64       `json:"tong_dat_cho"`
	DatChoDaThanhToan    int64       `json:"dat_cho_da_thanh_toan"`
	TongDoanhThu         interface{} `json:"tong_doanh_thu"`
	DoanhThuThangNay     interface{} `json:"doanh_thu_thang_nay"`
	TongDanhGia          int64       `json:"tong_danh_gia"`
	DiemDanhGiaTrungBinh interface{} `json:"diem_danh_gia_trung_binh"`
}

// Tổng quan dashboard: tổng số người dùng, tour, booking, doanh thu
func (q *Queries) GetDashboardOverview(ctx context.Context) (GetDashboardOverviewRow, error) {
	row := q.db.QueryRow(ctx, getDashboardOverview)
	var i GetDashboardOverviewRow
	err := row.Scan(
		&i.TongNguoiDung,
		&i.TongKhachHang,
		&i.TongNhaCungCap,
		&i.TongTour,
		&i.TourDangHoatDong,
		&i.TongDatCho,
		&i.DatChoDaThanhToan,
		&i.TongDoanhThu,
		&i.DoanhThuThangNay,
		&i.TongDanhGia,
		&i.DiemDanhGiaTrungBinh,
	)
	return i, err
}

const getDashboardOverviewByMonthAndYear = `-- name: GetDashboardOverviewByMonthAndYear :one
SELECT 
    -- 1. ĐẶT CHỖ
    (SELECT COUNT(*) FROM dat_cho 
     WHERE ($1::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $2::int)
    ) AS tong_dat_cho,

    (SELECT COUNT(*) FROM dat_cho 
     WHERE trang_thai = 'da_huy'
       AND ($1::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $2::int)
    ) AS so_don_da_huy,

    -- 2. DOANH THU (Chỉ tính đơn thành công)
    (SELECT COALESCE(SUM(tong_tien), 0) FROM dat_cho 
     WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh') 
       AND ($1::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $2::int)
    ) AS doanh_thu,

    -- 3. VẬN HÀNH
    (SELECT COUNT(*) FROM khoi_hanh_tour 
     WHERE ($1::int = 0 OR EXTRACT(MONTH FROM ngay_khoi_hanh)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_khoi_hanh)::int = $2::int)
    ) AS so_chuyen_khoi_hanh,

    -- 4. KHÁCH HÀNG
    (SELECT COALESCE(SUM(so_nguoi_lon + so_tre_em), 0) FROM dat_cho 
     WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')
       AND ($1::int = 0 OR EXTRACT(MONTH FROM ngay_dat)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_dat)::int = $2::int)
    ) AS tong_luong_khach,

    -- 5. ĐÁNH GIÁ
    (SELECT COUNT(*) FROM danh_gia 
     WHERE ($1::int = 0 OR EXTRACT(MONTH FROM ngay_tao)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_tao)::int = $2::int)
    ) AS so_danh_gia_moi,

    (SELECT COALESCE(AVG(diem_danh_gia), 0) FROM danh_gia 
     WHERE ($1::int = 0 OR EXTRACT(MONTH FROM ngay_tao)::int = $1::int)
       AND ($2::int = 0 OR EXTRACT(YEAR FROM ngay_tao)::int = $2::int)
    ) AS diem_trung_binh
`

type GetDashboardOverviewByMonthAndYearParams struct {
	Thang int32 `json:"thang"`
	Nam   int32 `json:"nam"`
}

type GetDashboardOverviewByMonthAndYearRow struct {
	TongDatCho       int64       `json:"tong_dat_cho"`
	SoDonDaHuy       int64       `json:"so_don_da_huy"`
	DoanhThu         interface{} `json:"doanh_thu"`
	SoChuyenKhoiHanh int64       `json:"so_chuyen_khoi_hanh"`
	TongLuongKhach   interface{} `json:"tong_luong_khach"`
	SoDanhGiaMoi     int64       `json:"so_danh_gia_moi"`
	DiemTrungBinh    interface{} `json:"diem_trung_binh"`
}

// Tổng quan dashboard: tổng số người dùng, tour, booking, doanh thu
func (q *Queries) GetDashboardOverviewByMonthAndYear(ctx context.Context, arg GetDashboardOverviewByMonthAndYearParams) (GetDashboardOverviewByMonthAndYearRow, error) {
	row := q.db.QueryRow(ctx, getDashboardOverviewByMonthAndYear, arg.Thang, arg.Nam)
	var i GetDashboardOverviewByMonthAndYearRow
	err := row.Scan(
		&i.TongDatCho,
		&i.SoDonDaHuy,
		&i.DoanhThu,
		&i.SoChuyenKhoiHanh,
		&i.TongLuongKhach,
		&i.SoDanhGiaMoi,
		&i.DiemTrungBinh,
	)
	return i, err
}

const getMonthlyReport = `-- name: GetMonthlyReport :one

SELECT 
    -- Doanh thu
    COALESCE(SUM(dc.tong_tien) FILTER (WHERE dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')), 0) AS doanh_thu,
    COUNT(dc.id) AS tong_booking,
    COUNT(dc.id) FILTER (WHERE dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')) AS booking_thanh_cong,
    COUNT(dc.id) FILTER (WHERE dc.trang_thai = 'da_huy') AS booking_huy,
    
    -- Người dùng mới
    (SELECT COUNT(*) FROM nguoi_dung 
     WHERE DATE_TRUNC('month', ngay_tao) = DATE_TRUNC('month', $1::DATE)) AS nguoi_dung_moi,
    
    -- Tour mới
    (SELECT COUNT(*) FROM tour 
     WHERE DATE_TRUNC('month', ngay_tao) = DATE_TRUNC('month', $1::DATE)) AS tour_moi,
    
    -- Đánh giá
    (SELECT COUNT(*) FROM danh_gia 
     WHERE DATE_TRUNC('month', ngay_tao) = DATE_TRUNC('month', $1::DATE) AND dang_hoat_dong = TRUE) AS danh_gia_moi,
    (SELECT COALESCE(AVG(diem_danh_gia), 0) FROM danh_gia 
     WHERE DATE_TRUNC('month', ngay_tao) = DATE_TRUNC('month', $1::DATE) AND dang_hoat_dong = TRUE) AS diem_danh_gia_trung_binh

FROM dat_cho dc
WHERE DATE_TRUNC('month', dc.ngay_dat) = DATE_TRUNC('month', $1::DATE)
`

type GetMonthlyReportRow struct {
	DoanhThu             interface{} `json:"doanh_thu"`
	TongBooking          int64       `json:"tong_booking"`
	BookingThanhCong     int64       `json:"booking_thanh_cong"`
	BookingHuy           int64       `json:"booking_huy"`
	NguoiDungMoi         int64       `json:"nguoi_dung_moi"`
	TourMoi              int64       `json:"tour_moi"`
	DanhGiaMoi           int64       `json:"danh_gia_moi"`
	DiemDanhGiaTrungBinh interface{} `json:"diem_danh_gia_trung_binh"`
}

// =====================
// 12. COMPREHENSIVE REPORTS
// =====================
// Báo cáo tháng
func (q *Queries) GetMonthlyReport(ctx context.Context, dollar_1 pgtype.Date) (GetMonthlyReportRow, error) {
	row := q.db.QueryRow(ctx, getMonthlyReport, dollar_1)
	var i GetMonthlyReportRow
	err := row.Scan(
		&i.DoanhThu,
		&i.TongBooking,
		&i.BookingThanhCong,
		&i.BookingHuy,
		&i.NguoiDungMoi,
		&i.TourMoi,
		&i.DanhGiaMoi,
		&i.DiemDanhGiaTrungBinh,
	)
	return i, err
}

const getMostFavoritedTours = `-- name: GetMostFavoritedTours :many
SELECT 
    t.id,
    t.tieu_de,
    t.gia_nguoi_lon,
    ncc.ten AS ten_nha_cung_cap,
    COUNT(tyt.id) AS so_yeu_thich,
    (SELECT duong_dan FROM anh_tour WHERE tour_id = t.id AND la_anh_chinh = TRUE LIMIT 1) AS anh_chinh
FROM tour t
LEFT JOIN tour_yeu_thich tyt ON t.id = tyt.tour_id
LEFT JOIN nha_cung_cap ncc ON t.nha_cung_cap_id = ncc.id
WHERE t.dang_hoat_dong = TRUE AND t.trang_thai = 'cong_bo'
GROUP BY t.id, t.tieu_de, t.gia_nguoi_lon, ncc.ten
ORDER BY so_yeu_thich DESC
LIMIT $1
`

type GetMostFavoritedToursRow struct {
	ID            int32          `json:"id"`
	TieuDe        string         `json:"tieu_de"`
	GiaNguoiLon   pgtype.Numeric `json:"gia_nguoi_lon"`
	TenNhaCungCap *string        `json:"ten_nha_cung_cap"`
	SoYeuThich    int64          `json:"so_yeu_thich"`
	AnhChinh      string         `json:"anh_chinh"`
}

// Tours được yêu thích nhiều nhất
func (q *Queries) GetMostFavoritedTours(ctx context.Context, limit int32) ([]GetMostFavoritedToursRow, error) {
	rows, err := q.db.Query(ctx, getMostFavoritedTours, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetMostFavoritedToursRow
	for rows.Next() {
		var i GetMostFavoritedToursRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.GiaNguoiLon,
			&i.TenNhaCungCap,
			&i.SoYeuThich,
			&i.AnhChinh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getQuarterlyReport = `-- name: GetQuarterlyReport :many
SELECT 
    EXTRACT(YEAR FROM ngay_dat) AS nam,
    EXTRACT(QUARTER FROM ngay_dat) AS quy,
    COUNT(*) AS tong_booking,
    COALESCE(SUM(tong_tien) FILTER (WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')), 0) AS doanh_thu
FROM dat_cho
WHERE ngay_dat >= NOW() - INTERVAL '2 years'
GROUP BY EXTRACT(YEAR FROM ngay_dat), EXTRACT(QUARTER FROM ngay_dat)
ORDER BY nam ASC, quy ASC
`

type GetQuarterlyReportRow struct {
	Nam         pgtype.Numeric `json:"nam"`
	Quy         pgtype.Numeric `json:"quy"`
	TongBooking int64          `json:"tong_booking"`
	DoanhThu    interface{}    `json:"doanh_thu"`
}

// Báo cáo theo quý
func (q *Queries) GetQuarterlyReport(ctx context.Context) ([]GetQuarterlyReportRow, error) {
	rows, err := q.db.Query(ctx, getQuarterlyReport)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetQuarterlyReportRow
	for rows.Next() {
		var i GetQuarterlyReportRow
		if err := rows.Scan(
			&i.Nam,
			&i.Quy,
			&i.TongBooking,
			&i.DoanhThu,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRecentBookings = `-- name: GetRecentBookings :many
SELECT 
    dc.id,
    dc.ngay_dat,
    dc.tong_tien,
    dc.trang_thai,
    dc.so_nguoi_lon,
    dc.so_tre_em,
    nd.ho_ten AS ten_khach_hang,
    nd.email AS email_khach_hang,
    t.tieu_de AS ten_tour,
    kh.ngay_khoi_hanh
FROM dat_cho dc
JOIN nguoi_dung nd ON dc.nguoi_dung_id = nd.id
JOIN khoi_hanh_tour kh ON dc.khoi_hanh_id = kh.id
JOIN tour t ON kh.tour_id = t.id
ORDER BY dc.ngay_dat DESC
LIMIT $1
`

type GetRecentBookingsRow struct {
	ID             int32               `json:"id"`
	NgayDat        pgtype.Timestamp    `json:"ngay_dat"`
	TongTien       pgtype.Numeric      `json:"tong_tien"`
	TrangThai      NullTrangThaiDatCho `json:"trang_thai"`
	SoNguoiLon     *int32              `json:"so_nguoi_lon"`
	SoTreEm        *int32              `json:"so_tre_em"`
	TenKhachHang   string              `json:"ten_khach_hang"`
	EmailKhachHang string              `json:"email_khach_hang"`
	TenTour        string              `json:"ten_tour"`
	NgayKhoiHanh   pgtype.Date         `json:"ngay_khoi_hanh"`
}

// Booking gần đây
func (q *Queries) GetRecentBookings(ctx context.Context, limit int32) ([]GetRecentBookingsRow, error) {
	rows, err := q.db.Query(ctx, getRecentBookings, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetRecentBookingsRow
	for rows.Next() {
		var i GetRecentBookingsRow
		if err := rows.Scan(
			&i.ID,
			&i.NgayDat,
			&i.TongTien,
			&i.TrangThai,
			&i.SoNguoiLon,
			&i.SoTreEm,
			&i.TenKhachHang,
			&i.EmailKhachHang,
			&i.TenTour,
			&i.NgayKhoiHanh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRevenueByDay = `-- name: GetRevenueByDay :many
SELECT 
    DATE(dc.ngay_dat) AS ngay,
    COUNT(dc.id) AS so_booking,
    COALESCE(SUM(dc.tong_tien), 0) AS doanh_thu
FROM dat_cho dc
JOIN khoi_hanh_tour kh ON dc.khoi_hanh_id = kh.id
JOIN tour t ON kh.tour_id = t.id
WHERE 
    -- 1. Lọc Năm: Nếu tham số 'nam' truyền vào là 0, bỏ qua bộ lọc này
    ($1::int = 0 OR EXTRACT(YEAR FROM dc.ngay_dat)::INT = $1::int)
    
    -- 2. Lọc Tháng: Nếu tham số 'thang' truyền vào là 0, bỏ qua bộ lọc này
    AND ($2::int = 0 OR EXTRACT(MONTH FROM dc.ngay_dat)::INT = $2::int)
    
    -- 3. Lọc Nhà cung cấp: Nếu truyền vào NULL (narg), lấy tất cả
    AND ($3::uuid IS NULL OR t.nha_cung_cap_id = $3)
    
    -- 4. Trạng thái bắt buộc
    AND dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY DATE(dc.ngay_dat)
ORDER BY ngay ASC
`

type GetRevenueByDayParams struct {
	Nam          int32       `json:"nam"`
	Thang        int32       `json:"thang"`
	NhaCungCapID pgtype.UUID `json:"nha_cung_cap_id"`
}

type GetRevenueByDayRow struct {
	Ngay      pgtype.Date `json:"ngay"`
	SoBooking int64       `json:"so_booking"`
	DoanhThu  interface{} `json:"doanh_thu"`
}

// Doanh thu theo năm và tháng
func (q *Queries) GetRevenueByDay(ctx context.Context, arg GetRevenueByDayParams) ([]GetRevenueByDayRow, error) {
	rows, err := q.db.Query(ctx, getRevenueByDay, arg.Nam, arg.Thang, arg.NhaCungCapID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetRevenueByDayRow
	for rows.Next() {
		var i GetRevenueByDayRow
		if err := rows.Scan(&i.Ngay, &i.SoBooking, &i.DoanhThu); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getSupplierGrowthByMonth = `-- name: GetSupplierGrowthByMonth :many
SELECT 
    DATE_TRUNC('month', nd.ngay_tao) AS thang,
    COUNT(*) AS so_nha_cung_cap_moi
FROM nha_cung_cap ncc
JOIN nguoi_dung nd ON ncc.id = nd.id
WHERE nd.ngay_tao >= NOW() - INTERVAL '12 months'
GROUP BY DATE_TRUNC('month', nd.ngay_tao)
ORDER BY thang ASC
`

type GetSupplierGrowthByMonthRow struct {
	Thang           pgtype.Interval `json:"thang"`
	SoNhaCungCapMoi int64           `json:"so_nha_cung_cap_moi"`
}

// Tăng trưởng nhà cung cấp theo tháng
func (q *Queries) GetSupplierGrowthByMonth(ctx context.Context) ([]GetSupplierGrowthByMonthRow, error) {
	rows, err := q.db.Query(ctx, getSupplierGrowthByMonth)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetSupplierGrowthByMonthRow
	for rows.Next() {
		var i GetSupplierGrowthByMonthRow
		if err := rows.Scan(&i.Thang, &i.SoNhaCungCapMoi); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getSupplierStats = `-- name: GetSupplierStats :one
SELECT 
    COUNT(*) AS tong_nha_cung_cap,
    (SELECT COUNT(*) FROM tour WHERE dang_hoat_dong = TRUE) AS tong_tour,
    (SELECT COUNT(*) FROM tour WHERE dang_hoat_dong = TRUE AND trang_thai = 'cong_bo') AS tour_dang_cong_bo
`

type GetSupplierStatsRow struct {
	TongNhaCungCap int64 `json:"tong_nha_cung_cap"`
	TongTour       int64 `json:"tong_tour"`
	TourDangCongBo int64 `json:"tour_dang_cong_bo"`
}

// Tổng quan nhà cung cấp
func (q *Queries) GetSupplierStats(ctx context.Context) (GetSupplierStatsRow, error) {
	row := q.db.QueryRow(ctx, getSupplierStats)
	var i GetSupplierStatsRow
	err := row.Scan(&i.TongNhaCungCap, &i.TongTour, &i.TourDangCongBo)
	return i, err
}

const getTopActiveUsers = `-- name: GetTopActiveUsers :many
SELECT 
    nd.id,
    nd.ho_ten,
    nd.email,
    COUNT(dc.id) AS so_booking,
    COALESCE(SUM(dc.tong_tien), 0) AS tong_chi_tieu
FROM nguoi_dung nd
LEFT JOIN dat_cho dc ON nd.id = dc.nguoi_dung_id
WHERE nd.vai_tro = 'khach_hang' AND nd.dang_hoat_dong = TRUE
GROUP BY nd.id, nd.ho_ten, nd.email
ORDER BY so_booking DESC
LIMIT $1
`

type GetTopActiveUsersRow struct {
	ID          pgtype.UUID `json:"id"`
	HoTen       string      `json:"ho_ten"`
	Email       string      `json:"email"`
	SoBooking   int64       `json:"so_booking"`
	TongChiTieu interface{} `json:"tong_chi_tieu"`
}

// =====================================Khách hàng=====================================
// Top người dùng hoạt động nhiều nhất (theo số booking)
func (q *Queries) GetTopActiveUsers(ctx context.Context, limit int32) ([]GetTopActiveUsersRow, error) {
	rows, err := q.db.Query(ctx, getTopActiveUsers, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopActiveUsersRow
	for rows.Next() {
		var i GetTopActiveUsersRow
		if err := rows.Scan(
			&i.ID,
			&i.HoTen,
			&i.Email,
			&i.SoBooking,
			&i.TongChiTieu,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTopBookedTours = `-- name: GetTopBookedTours :many
SELECT 
    t.id,
    t.tieu_de,
    t.gia_nguoi_lon,
    ncc.ten AS ten_nha_cung_cap,
    dmt.ten AS ten_danh_muc,
    COUNT(dc.id) AS so_booking,
    COALESCE(SUM(dc.tong_tien), 0) AS tong_doanh_thu,
    COALESCE(AVG(dg.diem_danh_gia), 0) AS diem_trung_binh,
    (SELECT duong_dan FROM anh_tour WHERE tour_id = t.id AND la_anh_chinh = TRUE LIMIT 1) AS anh_chinh
FROM tour t
LEFT JOIN dat_cho dc ON dc.khoi_hanh_id IN (SELECT id FROM khoi_hanh_tour WHERE tour_id = t.id)
LEFT JOIN nha_cung_cap ncc ON t.nha_cung_cap_id = ncc.id
LEFT JOIN danh_muc_tour dmt ON t.danh_muc_id = dmt.id
LEFT JOIN danh_gia dg ON t.id = dg.tour_id AND dg.dang_hoat_dong = TRUE
WHERE t.dang_hoat_dong = TRUE AND t.trang_thai = 'cong_bo'
GROUP BY t.id, t.tieu_de, t.gia_nguoi_lon, ncc.ten, dmt.ten
ORDER BY so_booking DESC
LIMIT $1
`

type GetTopBookedToursRow struct {
	ID            int32          `json:"id"`
	TieuDe        string         `json:"tieu_de"`
	GiaNguoiLon   pgtype.Numeric `json:"gia_nguoi_lon"`
	TenNhaCungCap *string        `json:"ten_nha_cung_cap"`
	TenDanhMuc    *string        `json:"ten_danh_muc"`
	SoBooking     int64          `json:"so_booking"`
	TongDoanhThu  interface{}    `json:"tong_doanh_thu"`
	DiemTrungBinh interface{}    `json:"diem_trung_binh"`
	AnhChinh      string         `json:"anh_chinh"`
}

// Top tours được đặt nhiều nhất
func (q *Queries) GetTopBookedTours(ctx context.Context, limit int32) ([]GetTopBookedToursRow, error) {
	rows, err := q.db.Query(ctx, getTopBookedTours, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopBookedToursRow
	for rows.Next() {
		var i GetTopBookedToursRow
		if err := rows.Scan(
			&i.ID,
			&i.TieuDe,
			&i.GiaNguoiLon,
			&i.TenNhaCungCap,
			&i.TenDanhMuc,
			&i.SoBooking,
			&i.TongDoanhThu,
			&i.DiemTrungBinh,
			&i.AnhChinh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTopDestinations = `-- name: GetTopDestinations :many
SELECT 
    dd.id,
    dd.ten,
    dd.tinh,
    dd.quoc_gia,
    dd.anh,
    COUNT(DISTINCT tdd.tour_id) AS so_tour,
    COALESCE(SUM(dc.tong_tien), 0) AS tong_doanh_thu
FROM diem_den dd
LEFT JOIN tour_diem_den tdd ON dd.id = tdd.diem_den_id
LEFT JOIN tour t ON tdd.tour_id = t.id AND t.dang_hoat_dong = TRUE
LEFT JOIN khoi_hanh_tour kh ON t.id = kh.tour_id
LEFT JOIN dat_cho dc ON kh.id = dc.khoi_hanh_id AND dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')
GROUP BY dd.id, dd.ten, dd.tinh, dd.quoc_gia, dd.anh
ORDER BY so_tour DESC
LIMIT $1
`

type GetTopDestinationsRow struct {
	ID           int32       `json:"id"`
	Ten          string      `json:"ten"`
	Tinh         *string     `json:"tinh"`
	QuocGia      *string     `json:"quoc_gia"`
	Anh          *string     `json:"anh"`
	SoTour       int64       `json:"so_tour"`
	TongDoanhThu interface{} `json:"tong_doanh_thu"`
}

// Top điểm đến phổ biến
func (q *Queries) GetTopDestinations(ctx context.Context, limit int32) ([]GetTopDestinationsRow, error) {
	rows, err := q.db.Query(ctx, getTopDestinations, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopDestinationsRow
	for rows.Next() {
		var i GetTopDestinationsRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Tinh,
			&i.QuocGia,
			&i.Anh,
			&i.SoTour,
			&i.TongDoanhThu,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTopSuppliersByRevenue = `-- name: GetTopSuppliersByRevenue :many
SELECT 
    ncc.id,
    ncc.ten,
    nd.email,
    ncc.logo,
    COUNT(DISTINCT t.id) AS so_tour,
    COUNT(dc.id) AS so_booking,
    COALESCE(SUM(dc.tong_tien), 0) AS tong_doanh_thu,
    COALESCE(AVG(dg.diem_danh_gia), 0) AS diem_trung_binh
FROM nha_cung_cap ncc
JOIN nguoi_dung nd ON ncc.id = nd.id
LEFT JOIN tour t ON ncc.id = t.nha_cung_cap_id AND t.dang_hoat_dong = TRUE
LEFT JOIN khoi_hanh_tour kh ON t.id = kh.tour_id
LEFT JOIN dat_cho dc ON kh.id = dc.khoi_hanh_id AND dc.trang_thai IN ('da_thanh_toan', 'hoan_thanh')
LEFT JOIN danh_gia dg ON t.id = dg.tour_id AND dg.dang_hoat_dong = TRUE
GROUP BY ncc.id, ncc.ten, nd.email, ncc.logo
ORDER BY tong_doanh_thu DESC
LIMIT $1
`

type GetTopSuppliersByRevenueRow struct {
	ID            pgtype.UUID `json:"id"`
	Ten           string      `json:"ten"`
	Email         string      `json:"email"`
	Logo          *string     `json:"logo"`
	SoTour        int64       `json:"so_tour"`
	SoBooking     int64       `json:"so_booking"`
	TongDoanhThu  interface{} `json:"tong_doanh_thu"`
	DiemTrungBinh interface{} `json:"diem_trung_binh"`
}

// Top nhà cung cấp theo doanh thu
func (q *Queries) GetTopSuppliersByRevenue(ctx context.Context, limit int32) ([]GetTopSuppliersByRevenueRow, error) {
	rows, err := q.db.Query(ctx, getTopSuppliersByRevenue, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopSuppliersByRevenueRow
	for rows.Next() {
		var i GetTopSuppliersByRevenueRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Email,
			&i.Logo,
			&i.SoTour,
			&i.SoBooking,
			&i.TongDoanhThu,
			&i.DiemTrungBinh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTopSuppliersByTours = `-- name: GetTopSuppliersByTours :many
SELECT 
    ncc.id,
    ncc.ten,
    nd.email,
    ncc.logo,
    COUNT(t.id) AS so_tour,
    COUNT(t.id) FILTER (WHERE t.trang_thai = 'cong_bo') AS tour_cong_bo,
    COUNT(t.id) FILTER (WHERE t.noi_bat = TRUE) AS tour_noi_bat
FROM nha_cung_cap ncc
JOIN nguoi_dung nd ON ncc.id = nd.id
LEFT JOIN tour t ON ncc.id = t.nha_cung_cap_id AND t.dang_hoat_dong = TRUE
GROUP BY ncc.id, ncc.ten, nd.email, ncc.logo
ORDER BY so_tour DESC
LIMIT $1
`

type GetTopSuppliersByToursRow struct {
	ID         pgtype.UUID `json:"id"`
	Ten        string      `json:"ten"`
	Email      string      `json:"email"`
	Logo       *string     `json:"logo"`
	SoTour     int64       `json:"so_tour"`
	TourCongBo int64       `json:"tour_cong_bo"`
	TourNoiBat int64       `json:"tour_noi_bat"`
}

// Top nhà cung cấp theo số tour
func (q *Queries) GetTopSuppliersByTours(ctx context.Context, limit int32) ([]GetTopSuppliersByToursRow, error) {
	rows, err := q.db.Query(ctx, getTopSuppliersByTours, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopSuppliersByToursRow
	for rows.Next() {
		var i GetTopSuppliersByToursRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Email,
			&i.Logo,
			&i.SoTour,
			&i.TourCongBo,
			&i.TourNoiBat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTourPriceDistribution = `-- name: GetTourPriceDistribution :many
SELECT 
    CASE 
        WHEN gia_nguoi_lon < 1000000 THEN 'Dưới 1 triệu'
        WHEN gia_nguoi_lon >= 1000000 AND gia_nguoi_lon < 3000000 THEN '1-3 triệu'
        WHEN gia_nguoi_lon >= 3000000 AND gia_nguoi_lon < 5000000 THEN '3-5 triệu'
        WHEN gia_nguoi_lon >= 5000000 AND gia_nguoi_lon < 10000000 THEN '5-10 triệu'
        ELSE 'Trên 10 triệu'
    END AS khoang_gia,
    COUNT(*) AS so_luong
FROM tour
WHERE dang_hoat_dong = TRUE AND trang_thai = 'cong_bo'
GROUP BY khoang_gia
ORDER BY 
    CASE khoang_gia
        WHEN 'Dưới 1 triệu' THEN 1
        WHEN '1-3 triệu' THEN 2
        WHEN '3-5 triệu' THEN 3
        WHEN '5-10 triệu' THEN 4
        ELSE 5
    END
`

type GetTourPriceDistributionRow struct {
	KhoangGia string `json:"khoang_gia"`
	SoLuong   int64  `json:"so_luong"`
}

// Phân bố giá tour
func (q *Queries) GetTourPriceDistribution(ctx context.Context) ([]GetTourPriceDistributionRow, error) {
	rows, err := q.db.Query(ctx, getTourPriceDistribution)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTourPriceDistributionRow
	for rows.Next() {
		var i GetTourPriceDistributionRow
		if err := rows.Scan(&i.KhoangGia, &i.SoLuong); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getUpcomingDepartures = `-- name: GetUpcomingDepartures :many

SELECT 
    kh.id,
    kh.ngay_khoi_hanh,
    kh.ngay_ket_thuc,
    kh.suc_chua,
    kh.so_cho_da_dat,
    kh.trang_thai,
    t.tieu_de AS ten_tour,
    t.gia_nguoi_lon,
    ncc.ten AS ten_nha_cung_cap,
    (kh.suc_chua - kh.so_cho_da_dat) AS cho_con_trong
FROM khoi_hanh_tour kh
JOIN tour t ON kh.tour_id = t.id
LEFT JOIN nha_cung_cap ncc ON t.nha_cung_cap_id = ncc.id
WHERE kh.ngay_khoi_hanh >= CURRENT_DATE
  AND kh.trang_thai IN ('len_lich', 'xac_nhan', 'con_cho')
ORDER BY kh.ngay_khoi_hanh ASC
LIMIT $1
`

type GetUpcomingDeparturesRow struct {
	ID            int32                 `json:"id"`
	NgayKhoiHanh  pgtype.Date           `json:"ngay_khoi_hanh"`
	NgayKetThuc   pgtype.Date           `json:"ngay_ket_thuc"`
	SucChua       int32                 `json:"suc_chua"`
	SoChoDaDat    *int32                `json:"so_cho_da_dat"`
	TrangThai     NullTrangThaiKhoiHanh `json:"trang_thai"`
	TenTour       string                `json:"ten_tour"`
	GiaNguoiLon   pgtype.Numeric        `json:"gia_nguoi_lon"`
	TenNhaCungCap *string               `json:"ten_nha_cung_cap"`
	ChoConTrong   int32                 `json:"cho_con_trong"`
}

// =====================
// 9. DEPARTURE STATISTICS
// =====================
// Các khởi hành sắp tới
func (q *Queries) GetUpcomingDepartures(ctx context.Context, limit int32) ([]GetUpcomingDeparturesRow, error) {
	rows, err := q.db.Query(ctx, getUpcomingDepartures, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetUpcomingDeparturesRow
	for rows.Next() {
		var i GetUpcomingDeparturesRow
		if err := rows.Scan(
			&i.ID,
			&i.NgayKhoiHanh,
			&i.NgayKetThuc,
			&i.SucChua,
			&i.SoChoDaDat,
			&i.TrangThai,
			&i.TenTour,
			&i.GiaNguoiLon,
			&i.TenNhaCungCap,
			&i.ChoConTrong,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getUserStatsByRole = `-- name: GetUserStatsByRole :many

SELECT 
    vai_tro,
    COUNT(*) AS so_luong,
    COUNT(*) FILTER (WHERE dang_hoat_dong = TRUE) AS dang_hoat_dong,
    COUNT(*) FILTER (WHERE xac_thuc = TRUE) AS da_xac_thuc
FROM nguoi_dung
GROUP BY vai_tro
ORDER BY so_luong DESC
`

type GetUserStatsByRoleRow struct {
	VaiTro       NullVaiTroNguoiDung `json:"vai_tro"`
	SoLuong      int64               `json:"so_luong"`
	DangHoatDong int64               `json:"dang_hoat_dong"`
	DaXacThuc    int64               `json:"da_xac_thuc"`
}

// =====================
// 2. USER STATISTICS
// =====================
// Thống kê người dùng theo vai trò
func (q *Queries) GetUserStatsByRole(ctx context.Context) ([]GetUserStatsByRoleRow, error) {
	rows, err := q.db.Query(ctx, getUserStatsByRole)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetUserStatsByRoleRow
	for rows.Next() {
		var i GetUserStatsByRoleRow
		if err := rows.Scan(
			&i.VaiTro,
			&i.SoLuong,
			&i.DangHoatDong,
			&i.DaXacThuc,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getYearlyComparisonReport = `-- name: GetYearlyComparisonReport :many
SELECT 
    EXTRACT(YEAR FROM ngay_dat) AS nam,
    COUNT(*) AS tong_booking,
    COALESCE(SUM(tong_tien) FILTER (WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')), 0) AS doanh_thu,
    COALESCE(AVG(tong_tien) FILTER (WHERE trang_thai IN ('da_thanh_toan', 'hoan_thanh')), 0) AS gia_tri_trung_binh
FROM dat_cho
GROUP BY EXTRACT(YEAR FROM ngay_dat)
ORDER BY nam ASC
`

type GetYearlyComparisonReportRow struct {
	Nam             pgtype.Numeric `json:"nam"`
	TongBooking     int64          `json:"tong_booking"`
	DoanhThu        interface{}    `json:"doanh_thu"`
	GiaTriTrungBinh interface{}    `json:"gia_tri_trung_binh"`
}

// So sánh theo năm
func (q *Queries) GetYearlyComparisonReport(ctx context.Context) ([]GetYearlyComparisonReportRow, error) {
	rows, err := q.db.Query(ctx, getYearlyComparisonReport)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetYearlyComparisonReportRow
	for rows.Next() {
		var i GetYearlyComparisonReportRow
		if err := rows.Scan(
			&i.Nam,
			&i.TongBooking,
			&i.DoanhThu,
			&i.GiaTriTrungBinh,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const rejectSupplier = `-- name: RejectSupplier :one
UPDATE nguoi_dung
SET 
    dang_hoat_dong = FALSE,
    xac_thuc = FALSE,
    ngay_cap_nhat = CURRENT_TIMESTAMP
WHERE id = $1 
    AND vai_tro = 'nha_cung_cap'
RETURNING id, ho_ten, email, mat_khau_ma_hoa, so_dien_thoai, vai_tro, dang_hoat_dong, xac_thuc, ngay_tao, ngay_cap_nhat
`

// từ chối nhà cung cấp
func (q *Queries) RejectSupplier(ctx context.Context, id pgtype.UUID) (NguoiDung, error) {
	row := q.db.QueryRow(ctx, rejectSupplier, id)
	var i NguoiDung
	err := row.Scan(
		&i.ID,
		&i.HoTen,
		&i.Email,
		&i.MatKhauMaHoa,
		&i.SoDienThoai,
		&i.VaiTro,
		&i.DangHoatDong,
		&i.XacThuc,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const restoreSupplier = `-- name: RestoreSupplier :one
UPDATE nguoi_dung
SET
    dang_hoat_dong = TRUE,
    ngay_cap_nhat = CURRENT_TIMESTAMP
WHERE id = $1 AND vai_tro = 'nha_cung_cap'
RETURNING id, ho_ten, email, mat_khau_ma_hoa, so_dien_thoai, vai_tro, dang_hoat_dong, xac_thuc, ngay_tao, ngay_cap_nhat
`

func (q *Queries) RestoreSupplier(ctx context.Context, id pgtype.UUID) (NguoiDung, error) {
	row := q.db.QueryRow(ctx, restoreSupplier, id)
	var i NguoiDung
	err := row.Scan(
		&i.ID,
		&i.HoTen,
		&i.Email,
		&i.MatKhauMaHoa,
		&i.SoDienThoai,
		&i.VaiTro,
		&i.DangHoatDong,
		&i.XacThuc,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const softDeleteSupplier = `-- name: SoftDeleteSupplier :exec
UPDATE nguoi_dung
SET
    dang_hoat_dong = FALSE,
    ngay_cap_nhat = CURRENT_TIMESTAMP
WHERE id = $1 AND vai_tro = 'nha_cung_cap'
`

func (q *Queries) SoftDeleteSupplier(ctx context.Context, id pgtype.UUID) error {
	_, err := q.db.Exec(ctx, softDeleteSupplier, id)
	return err
}

const supplierOptions = `-- name: SupplierOptions :many

select nha_cung_cap.id, nha_cung_cap.ten from nha_cung_cap
join nguoi_dung on nguoi_dung.id = nha_cung_cap.id
where dang_hoat_dong = true
and nguoi_dung.vai_tro = 'nha_cung_cap'
order by nguoi_dung.ngay_tao desc
`

type SupplierOptionsRow struct {
	ID  pgtype.UUID `json:"id"`
	Ten string      `json:"ten"`
}

// ===========================================
// ADMIN STATISTICS QUERIES
// ===========================================
// =====================
// 1. DASHBOARD OVERVIEW
// =====================
func (q *Queries) SupplierOptions(ctx context.Context) ([]SupplierOptionsRow, error) {
	rows, err := q.db.Query(ctx, supplierOptions)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []SupplierOptionsRow
	for rows.Next() {
		var i SupplierOptionsRow
		if err := rows.Scan(&i.ID, &i.Ten); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
