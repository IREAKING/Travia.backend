// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: destination.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const createDestination = `-- name: CreateDestination :one
INSERT INTO diem_den (
    ten,
    quoc_gia,
    khu_vuc,
    mo_ta,
    anh,
    vi_do,
    kinh_do
) VALUES (
    $1, $2, $3, $4, $5, $6, $7
)
RETURNING id, ten, tinh, quoc_gia, khu_vuc, iso2, iso3, mo_ta, anh, vi_do, kinh_do, ngay_tao, ngay_cap_nhat
`

type CreateDestinationParams struct {
	Ten     string         `json:"ten"`
	QuocGia *string        `json:"quoc_gia"`
	KhuVuc  *string        `json:"khu_vuc"`
	MoTa    *string        `json:"mo_ta"`
	Anh     *string        `json:"anh"`
	ViDo    pgtype.Numeric `json:"vi_do"`
	KinhDo  pgtype.Numeric `json:"kinh_do"`
}

func (q *Queries) CreateDestination(ctx context.Context, arg CreateDestinationParams) (DiemDen, error) {
	row := q.db.QueryRow(ctx, createDestination,
		arg.Ten,
		arg.QuocGia,
		arg.KhuVuc,
		arg.MoTa,
		arg.Anh,
		arg.ViDo,
		arg.KinhDo,
	)
	var i DiemDen
	err := row.Scan(
		&i.ID,
		&i.Ten,
		&i.Tinh,
		&i.QuocGia,
		&i.KhuVuc,
		&i.Iso2,
		&i.Iso3,
		&i.MoTa,
		&i.Anh,
		&i.ViDo,
		&i.KinhDo,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const getCityByProvince = `-- name: GetCityByProvince :many
SELECT id, ten FROM diem_den
WHERE tinh = $1
GROUP BY ten, id
`

type GetCityByProvinceRow struct {
	ID  int32  `json:"id"`
	Ten string `json:"ten"`
}

func (q *Queries) GetCityByProvince(ctx context.Context, tinh *string) ([]GetCityByProvinceRow, error) {
	rows, err := q.db.Query(ctx, getCityByProvince, tinh)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetCityByProvinceRow
	for rows.Next() {
		var i GetCityByProvinceRow
		if err := rows.Scan(&i.ID, &i.Ten); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getCountry = `-- name: GetCountry :many
SELECT id, quoc_gia FROM diem_den
GROUP BY quoc_gia, id
`

type GetCountryRow struct {
	ID      int32   `json:"id"`
	QuocGia *string `json:"quoc_gia"`
}

func (q *Queries) GetCountry(ctx context.Context) ([]GetCountryRow, error) {
	rows, err := q.db.Query(ctx, getCountry)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetCountryRow
	for rows.Next() {
		var i GetCountryRow
		if err := rows.Scan(&i.ID, &i.QuocGia); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDestinationByID = `-- name: GetDestinationByID :one
SELECT 
    id,
    ten,
    tinh,
    quoc_gia,
    khu_vuc,
    iso2,
    iso3,
    mo_ta,
    anh,
    vi_do,
    kinh_do,
    ngay_tao,
    ngay_cap_nhat
FROM diem_den
WHERE id = $1
`

// Lấy thông tin chi tiết điểm đến theo ID
func (q *Queries) GetDestinationByID(ctx context.Context, id int32) (DiemDen, error) {
	row := q.db.QueryRow(ctx, getDestinationByID, id)
	var i DiemDen
	err := row.Scan(
		&i.ID,
		&i.Ten,
		&i.Tinh,
		&i.QuocGia,
		&i.KhuVuc,
		&i.Iso2,
		&i.Iso3,
		&i.MoTa,
		&i.Anh,
		&i.ViDo,
		&i.KinhDo,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}

const getPopularDestinations = `-- name: GetPopularDestinations :many
SELECT 
    dd.id,
    dd.ten,
    dd.tinh,
    dd.quoc_gia,
    dd.khu_vuc,
    dd.mo_ta,
    dd.anh,
    dd.vi_do,
    dd.kinh_do,
    COUNT(DISTINCT CASE WHEN t.trang_thai = 'cong_bo' AND t.dang_hoat_dong = TRUE THEN tdd.tour_id END) as so_luong_tour
FROM diem_den dd
LEFT JOIN tour_diem_den tdd ON dd.id = tdd.diem_den_id
LEFT JOIN tour t ON tdd.tour_id = t.id
GROUP BY dd.id, dd.ten, dd.tinh, dd.quoc_gia, dd.khu_vuc, dd.mo_ta, dd.anh, dd.vi_do, dd.kinh_do
HAVING COUNT(DISTINCT CASE WHEN t.trang_thai = 'cong_bo' AND t.dang_hoat_dong = TRUE THEN tdd.tour_id END) > 0
ORDER BY so_luong_tour DESC, dd.ten ASC
LIMIT $1
`

type GetPopularDestinationsRow struct {
	ID          int32          `json:"id"`
	Ten         string         `json:"ten"`
	Tinh        *string        `json:"tinh"`
	QuocGia     *string        `json:"quoc_gia"`
	KhuVuc      *string        `json:"khu_vuc"`
	MoTa        *string        `json:"mo_ta"`
	Anh         *string        `json:"anh"`
	ViDo        pgtype.Numeric `json:"vi_do"`
	KinhDo      pgtype.Numeric `json:"kinh_do"`
	SoLuongTour int64          `json:"so_luong_tour"`
}

// Lấy các điểm đến phổ biến nhất (được nhiều tour sử dụng nhất)
func (q *Queries) GetPopularDestinations(ctx context.Context, limit int32) ([]GetPopularDestinationsRow, error) {
	rows, err := q.db.Query(ctx, getPopularDestinations, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetPopularDestinationsRow
	for rows.Next() {
		var i GetPopularDestinationsRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Tinh,
			&i.QuocGia,
			&i.KhuVuc,
			&i.MoTa,
			&i.Anh,
			&i.ViDo,
			&i.KinhDo,
			&i.SoLuongTour,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getProvinceByCountry = `-- name: GetProvinceByCountry :many
SELECT id, tinh FROM diem_den
WHERE quoc_gia = $1
GROUP BY tinh, id
`

type GetProvinceByCountryRow struct {
	ID   int32   `json:"id"`
	Tinh *string `json:"tinh"`
}

func (q *Queries) GetProvinceByCountry(ctx context.Context, quocGia *string) ([]GetProvinceByCountryRow, error) {
	rows, err := q.db.Query(ctx, getProvinceByCountry, quocGia)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetProvinceByCountryRow
	for rows.Next() {
		var i GetProvinceByCountryRow
		if err := rows.Scan(&i.ID, &i.Tinh); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTopPopularDestinations = `-- name: GetTopPopularDestinations :many
SELECT 
    dd.id,
    dd.ten,
    dd.tinh,
    dd.quoc_gia,
    dd.khu_vuc,
    dd.mo_ta,
    dd.anh,
    dd.vi_do,
    dd.kinh_do,
    COUNT(DISTINCT tdd.tour_id) as so_luong_tour,
    COUNT(DISTINCT CASE WHEN t.noi_bat = TRUE THEN t.id END) as so_tour_noi_bat
FROM diem_den dd
INNER JOIN tour_diem_den tdd ON dd.id = tdd.diem_den_id
INNER JOIN tour t ON tdd.tour_id = t.id
WHERE t.trang_thai = 'cong_bo' 
    AND t.dang_hoat_dong = TRUE
GROUP BY dd.id, dd.ten, dd.tinh, dd.quoc_gia, dd.khu_vuc, dd.mo_ta, dd.anh, dd.vi_do, dd.kinh_do
HAVING COUNT(DISTINCT tdd.tour_id) > 0
ORDER BY so_luong_tour DESC, so_tour_noi_bat DESC, dd.ten ASC
LIMIT $1
`

type GetTopPopularDestinationsRow struct {
	ID           int32          `json:"id"`
	Ten          string         `json:"ten"`
	Tinh         *string        `json:"tinh"`
	QuocGia      *string        `json:"quoc_gia"`
	KhuVuc       *string        `json:"khu_vuc"`
	MoTa         *string        `json:"mo_ta"`
	Anh          *string        `json:"anh"`
	ViDo         pgtype.Numeric `json:"vi_do"`
	KinhDo       pgtype.Numeric `json:"kinh_do"`
	SoLuongTour  int64          `json:"so_luong_tour"`
	SoTourNoiBat int64          `json:"so_tour_noi_bat"`
}

// Lấy top N điểm đến phổ biến nhất với thông tin chi tiết (có số tour nổi bật)
func (q *Queries) GetTopPopularDestinations(ctx context.Context, limit int32) ([]GetTopPopularDestinationsRow, error) {
	rows, err := q.db.Query(ctx, getTopPopularDestinations, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetTopPopularDestinationsRow
	for rows.Next() {
		var i GetTopPopularDestinationsRow
		if err := rows.Scan(
			&i.ID,
			&i.Ten,
			&i.Tinh,
			&i.QuocGia,
			&i.KhuVuc,
			&i.MoTa,
			&i.Anh,
			&i.ViDo,
			&i.KinhDo,
			&i.SoLuongTour,
			&i.SoTourNoiBat,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateDestinationImage = `-- name: UpdateDestinationImage :one
UPDATE diem_den
SET anh = $2,
    ngay_cap_nhat = CURRENT_TIMESTAMP
WHERE id = $1
RETURNING id, ten, tinh, quoc_gia, khu_vuc, iso2, iso3, mo_ta, anh, vi_do, kinh_do, ngay_tao, ngay_cap_nhat
`

type UpdateDestinationImageParams struct {
	ID  int32   `json:"id"`
	Anh *string `json:"anh"`
}

// Cập nhật hình ảnh cho điểm đến
func (q *Queries) UpdateDestinationImage(ctx context.Context, arg UpdateDestinationImageParams) (DiemDen, error) {
	row := q.db.QueryRow(ctx, updateDestinationImage, arg.ID, arg.Anh)
	var i DiemDen
	err := row.Scan(
		&i.ID,
		&i.Ten,
		&i.Tinh,
		&i.QuocGia,
		&i.KhuVuc,
		&i.Iso2,
		&i.Iso3,
		&i.MoTa,
		&i.Anh,
		&i.ViDo,
		&i.KinhDo,
		&i.NgayTao,
		&i.NgayCapNhat,
	)
	return i, err
}
